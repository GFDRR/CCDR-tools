
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>&lt;no title&gt; &#8212; Climate &amp; Disaster Risk Screening Tools</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://GFDRR.github.io/CCDR-tools/Top-down/notebooks/Flood.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Expected Annual Exposure (EAE)" href="../procedures/Analytical_procedure_classes.html" />
    <link rel="prev" title="Expected Annual Impact (EAI)" href="../procedures/Analytical_procedure_function.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Climate & Disaster Risk Screening Tools</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Risk Data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/intro-risk.html">
   Disaster risk from natural hazards
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/hazard-data.html">
   Natural Hazards
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/exposure-data.html">
   Exposure data
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Global Risk Data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../docs/global-data.html">
   Foundational Datasets, Data Products, &amp; Sample Indicators
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="simple">
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analytical approaches
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../procedures/Analytical_procedure_function.html">
   Expected Annual Impact (EAI)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../procedures/Analytical_procedure_classes.html">
   Expected Annual Exposure (EAE)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Jupyter Notebooks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="readme.html">
   ANALYTICAL NOTEBOOKS
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Acknowledgements
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/team.html">
   Team and Acknowledgements
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/GFDRR/CCDR-tools/main?urlpath=tree/Top-down/notebooks/Flood.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/GFDRR/CCDR-tools"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/GFDRR/CCDR-tools/issues/new?title=Issue%20on%20page%20%2FTop-down/notebooks/Flood.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/GFDRR/CCDR-tools/edit/main/Top-down/notebooks/Flood.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/Top-down/notebooks/Flood.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="simple visible nav section-nav flex-column">
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><no title></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="simple visible nav section-nav flex-column">
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <p>CCDR Hazard Analysis Notebook
Developed by M. Amadio and T. Iwanaga</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># import necessary packages</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="kn">import</span> <span class="n">Pdb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">country_code_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;NPL&quot;</span><span class="p">:</span> <span class="mi">175</span><span class="p">,</span>
    <span class="s2">&quot;PAK&quot;</span><span class="p">:</span> <span class="mi">188</span><span class="p">,</span>
    <span class="s2">&quot;BGD&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
    <span class="s2">&quot;GHA&quot;</span><span class="p">:</span> <span class="mi">94</span><span class="p">,</span>
    <span class="s2">&quot;ETH&quot;</span><span class="p">:</span> <span class="mi">79</span><span class="p">,</span>
    <span class="s2">&quot;BFA&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;MLI&quot;</span><span class="p">:</span> <span class="mi">155</span><span class="p">,</span>
    <span class="s2">&quot;NER&quot;</span><span class="p">:</span> <span class="mi">181</span><span class="p">,</span>
    <span class="s2">&quot;TCD&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;MRT&quot;</span><span class="p">:</span> <span class="mi">159</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">damage_factor_builtup</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A polynomial fit to average damage across builtup land cover relative </span>
<span class="sd">    to water depth in meters in Asia.</span>

<span class="sd">    The sectors are commercial, industry, transport, infrastructure and residential.</span>

<span class="sd">    Values are capped between 0 and 1, where values &gt;= 6m = 1</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] JRC, 2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0028</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">0.0362</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.0095</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="c1"># Floods - AFRICA</span>
    <span class="c1">#return np.maximum(0.0, np.minimum(1.0, 0.00723*x**3 - 0.1000*x**2 + 0.5060*x)) # Floods - ASIA</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">damage_factor_agri</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A polynomial fit to average damage across agricultural land cover relative </span>
<span class="sd">    to water depth in meters in Asia.</span>

<span class="sd">    Values are capped between 0 and 1, where values &gt;= 6m = 1</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] JRC, 2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.00723</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.506</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mortality_factor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A polynomial fit to average population mortality due to nearby flooding.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Jonkman et al, 2008</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.985</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.32</span><span class="o">-</span><span class="mf">1.412</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preview_impact_func</span><span class="p">(</span><span class="n">bt</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">mortality_factor</span>
    <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;builtup&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">damage_factor_builtup</span>
    <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;agri&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">damage_factor_agri</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown exposure category&quot;</span><span class="p">)</span>
    
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">damage_factor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">label_steps</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">label_steps</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">label_steps</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hazard intensity&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Impact Factor&quot;</span><span class="p">)</span>
        
        <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="n">rb</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
        <span class="n">rb</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preview_impact_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running analysis...&quot;</span><span class="p">)</span>
        
    <span class="n">analysis_type</span> <span class="o">=</span> <span class="n">analysis_app_dd</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
        <span class="c1"># Ensure class threshold values are valid</span>

        <span class="n">bin_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">class_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>        
        <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="n">bin_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bin_seq</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_seq</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Class thresholds are not sequential. Lower classes must be less than class thresholds above.&quot;</span><span class="p">)</span>
            <span class="n">rb</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">preview_impact_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        
        <span class="n">max_bin_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_seq</span><span class="p">)</span>
        <span class="n">max_haz_threshold</span> <span class="o">=</span> <span class="n">max_bin_value</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">bin_seq</span> <span class="o">=</span> <span class="n">bin_seq</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_seq</span><span class="p">)</span>

    <span class="c1"># Get user input</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">country_dd</span><span class="o">.</span><span class="n">value</span>
    <span class="n">exp_cat</span> <span class="o">=</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span>
    <span class="n">time_horizon</span> <span class="o">=</span> <span class="n">time_horizon_dd</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rcp_scenario</span> <span class="o">=</span> <span class="n">rcp_scenario_dd</span><span class="o">.</span><span class="n">value</span>

    <span class="n">target_ADM</span> <span class="o">=</span> <span class="n">adm_dd</span><span class="o">.</span><span class="n">value</span>
    <span class="n">adm_name</span> <span class="o">=</span> <span class="n">target_ADM</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
        <span class="n">min_haz_threshold</span> <span class="o">=</span> <span class="n">class_edges</span><span class="p">[</span><span class="s1">&#39;class_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_haz_threshold</span> <span class="o">=</span> <span class="n">min_haz_slider</span><span class="o">.</span><span class="n">value</span>

    <span class="n">valid_RPs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>

    <span class="c1"># Testing data file locations</span>
    <span class="c1"># TODO: Temp data store, to be replaced with a config spec (.env file?) before deployment</span>
    
    <span class="n">exposure_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/EXP/</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">mortality_factor</span>
        <span class="n">exp_raster_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exposure_dir</span><span class="si">}</span><span class="s2">_WPOP20.tif&quot;</span>
    <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;builtup&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">damage_factor_builtup</span>
        <span class="n">exp_raster_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exposure_dir</span><span class="si">}</span><span class="s2">_WSF19.tif&quot;</span>
    <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;agri&#39;</span><span class="p">:</span>
        <span class="n">damage_factor</span> <span class="o">=</span> <span class="n">damage_factor_agri</span>
        <span class="n">exp_raster_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exposure_dir</span><span class="si">}</span><span class="s2">_ESA20_agri.tif&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing or unknown data layer </span><span class="si">{</span><span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Hazard data location</span>
    <span class="n">flood_RP_data_loc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/HZD&quot;</span>

    <span class="c1"># Run analysis</span>
    
    <span class="c1"># Open exposure dataset</span>
    <span class="n">exposure_rst</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">exp_raster_fn</span><span class="p">)</span>

    <span class="c1"># Indicate -1 values as representing no data.</span>
    <span class="n">exposure_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load ADM based on country code value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">adm_dataset</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ADM/</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_ADM.gpkg&quot;</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing ADM layer!&quot;</span><span class="p">)</span>
        
    <span class="n">adm_data</span> <span class="o">=</span> <span class="n">adm_dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adm_dataset</span><span class="o">.</span><span class="n">ADM0_CODE</span> <span class="o">==</span> <span class="n">country_code_map</span><span class="p">[</span><span class="n">country</span><span class="p">],</span> <span class="p">:]</span>
    
    <span class="c1"># Get all ADM code/name columns to save with results</span>
    <span class="n">adm_cols</span> <span class="o">=</span> <span class="n">adm_data</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">all_adm_codes</span> <span class="o">=</span> <span class="n">adm_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_CODE&quot;</span><span class="p">)</span>
    <span class="n">all_adm_names</span> <span class="o">=</span> <span class="n">adm_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_NAME&quot;</span><span class="p">)</span>
    
    <span class="n">all_adm_name_tmp</span> <span class="o">=</span> <span class="n">adm_cols</span><span class="p">[</span><span class="n">all_adm_names</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">all_adm_code_tmp</span> <span class="o">=</span> <span class="n">adm_cols</span><span class="p">[</span><span class="n">all_adm_codes</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

    <span class="n">result_df</span> <span class="o">=</span> <span class="n">adm_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">all_adm_code_tmp</span> <span class="o">+</span> <span class="n">all_adm_name_tmp</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>
    
    <span class="c1"># Prep result structure</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
        <span class="n">exp_sum_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp_i</span><span class="si">}</span><span class="s2">_exp_tot&quot;</span> <span class="k">for</span> <span class="n">rp_i</span> <span class="ow">in</span> <span class="n">valid_RPs</span><span class="p">]</span>
        <span class="n">EAI_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp_i</span><span class="si">}</span><span class="s2">_EAI&quot;</span> <span class="k">for</span> <span class="n">rp_i</span> <span class="ow">in</span> <span class="n">valid_RPs</span><span class="p">]</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">exp_sum_cols</span> <span class="o">+</span> <span class="n">EAI_cols</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="c1"># Get total exposure for each ADM region</span>
    <span class="n">exp_per_ADM</span> <span class="o">=</span> <span class="n">gen_zonal_stats</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="n">adm_data</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">raster</span><span class="o">=</span><span class="n">exp_raster_fn</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">])</span>
    <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exp_per_ADM</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">valid_RPs</span><span class="p">:</span>
        <span class="c1"># Probability of return period</span>
        <span class="c1"># Essentially the same as 1/RP, but accounts for cases where RP == 1</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">rp</span><span class="p">)</span>

        <span class="c1"># Load corresponding flood dataset</span>
        <span class="n">flood_rst</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flood_RP_data_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">))</span>

        <span class="c1"># Reproject and clip raster to same bounds as exposure data</span>
        <span class="n">flood_rst</span> <span class="o">=</span> <span class="n">flood_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">exposure_rst</span><span class="p">)</span>
        
        <span class="c1"># Get raw array values for exposure and hazard layer</span>
        <span class="n">flood_arr</span> <span class="o">=</span> <span class="n">flood_rst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">flood_arr</span><span class="p">[</span><span class="n">flood_arr</span> <span class="o">&lt;</span> <span class="n">min_haz_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Set values below min threshold to nan</span>
        
        <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
            <span class="c1"># Assign impact factor (this is F_i)</span>
            <span class="k">if</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;pop&#39;</span><span class="p">:</span>
                <span class="n">impact_arr</span> <span class="o">=</span> <span class="n">mortality_factor</span><span class="p">(</span><span class="n">flood_arr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;builtup&#39;</span><span class="p">:</span>
                <span class="n">impact_arr</span> <span class="o">=</span> <span class="n">damage_factor_builtup</span><span class="p">(</span><span class="n">flood_arr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exp_cat_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;agri&#39;</span><span class="p">:</span>
                <span class="n">impact_arr</span> <span class="o">=</span> <span class="n">damage_factor_agri</span><span class="p">(</span><span class="n">flood_arr</span><span class="p">)</span>

            <span class="c1"># Create raster from array</span>
            <span class="n">impact_rst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">impact_arr</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                                      <span class="n">coords</span><span class="o">=</span><span class="n">flood_rst</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> 
                                      <span class="n">dims</span><span class="o">=</span><span class="n">flood_rst</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_inter_rst_chk</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">impact_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_flood_imp_factor.tif&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">impact_rst</span> <span class="o">=</span> <span class="n">flood_rst</span>

        <span class="c1"># Calculate affected exposure in ADM</span>
        <span class="c1"># Filter down to valid areas</span>
        <span class="n">valid_impact_areas</span> <span class="o">=</span> <span class="n">impact_rst</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">affected_exp_rst</span> <span class="o">=</span> <span class="n">exposure_rst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_impact_areas</span><span class="p">)</span>  <span class="c1"># Get total exposure in affected areas</span>
        <span class="n">affected_exp_rst</span> <span class="o">=</span> <span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">affected_exp_rst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Out of the above, get areas that have people</span>
        
        <span class="k">if</span> <span class="n">save_inter_rst_chk</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_flood_affected_.tif&quot;</span><span class="p">))</span>
               
        <span class="c1"># Conduct analyses for classes</span>
        <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
            <span class="n">flood_arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flood_arr</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set NaNs to 0</span>
            <span class="n">flood_arr</span><span class="p">[</span><span class="n">flood_arr</span> <span class="o">&gt;</span> <span class="n">max_bin_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_haz_threshold</span>  <span class="c1"># Cap large values to maximum threshold value</span>

            <span class="c1"># Assign bin values to raster data</span>
            <span class="c1"># Follows: x_{i-1} &lt;= x_{i} &lt; x_{i+1}</span>
            <span class="n">bin_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">flood_arr</span><span class="p">,</span> <span class="n">bin_seq</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">bin_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">):</span>
                <span class="n">impact_class</span> <span class="o">=</span> <span class="n">gen_zonal_stats</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="n">adm_data</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">raster</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_idx</span> <span class="o">==</span> <span class="n">bin_x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">],</span> <span class="n">affine</span><span class="o">=</span><span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(),</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_C</span><span class="si">{</span><span class="n">bin_x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">impact_class</span><span class="p">]</span>
            <span class="c1"># end</span>
            
            <span class="n">C_cols</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_C&quot;</span><span class="p">)</span>
            <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_tot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">C_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">continue</span>

        <span class="c1"># Calculate degree on impact over Exposure category</span>
        <span class="n">impact_exp_rst</span> <span class="o">=</span> <span class="n">affected_exp_rst</span> <span class="o">*</span> <span class="n">impact_rst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_impact_areas</span><span class="p">)</span>  <span class="c1"># Get impacted exposure in affected areas</span>
        
        <span class="k">if</span> <span class="n">save_inter_rst_chk</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">impact_exp_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_impact.tif&quot;</span><span class="p">))</span>

        
        <span class="n">impact_exp_per_ADM</span> <span class="o">=</span> <span class="n">gen_zonal_stats</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="n">adm_data</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">raster</span><span class="o">=</span><span class="n">impact_exp_rst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                             <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">],</span> <span class="n">affine</span><span class="o">=</span><span class="n">impact_exp_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_imp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">impact_exp_per_ADM</span><span class="p">]</span>

        <span class="c1"># EAI_i := F_i * freq</span>
        <span class="n">EAI_i</span> <span class="o">=</span> <span class="n">impact_exp_rst</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_impact_areas</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq</span>

        <span class="k">if</span> <span class="n">save_inter_rst_chk</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># Save intermediate file if requested</span>
            <span class="n">EAI_i</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_EAI.tif&quot;</span><span class="p">))</span>

        <span class="c1"># Get affected exposure per ADM</span>
        <span class="n">affected_exp_per_ADM</span> <span class="o">=</span> <span class="n">gen_zonal_stats</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="n">adm_data</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">raster</span><span class="o">=</span><span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                            <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">],</span> <span class="n">affine</span><span class="o">=</span><span class="n">affected_exp_rst</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_tot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">affected_exp_per_ADM</span><span class="p">]</span>


        <span class="n">EAI_per_ADM</span> <span class="o">=</span> <span class="n">gen_zonal_stats</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="n">adm_data</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span> <span class="n">raster</span><span class="o">=</span><span class="n">EAI_i</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">],</span> <span class="n">affine</span><span class="o">=</span><span class="n">EAI_i</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="p">(),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">result_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_EAI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">EAI_per_ADM</span><span class="p">]</span>
    <span class="c1"># End RP loop</span>

    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
        <span class="c1"># Sum all EAI to get total EAI across all RPs</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;_EAI&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate Exp_EAI% (Percent affected exposure per year)</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI%&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">100.0</span>
    
        <span class="c1"># Reorder - need ADM code, name, and exp at the front regardless of ADM level</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">all_adm_code_tmp</span> <span class="o">+</span> <span class="n">all_adm_name_tmp</span> <span class="o">+</span>
                                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RP10_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_tot&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RP100_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_tot&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RP1000_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_tot&quot;</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;RP10_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_imp&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RP100_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_imp&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RP1000_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_imp&quot;</span><span class="p">,</span> 
                                <span class="s2">&quot;RP10_EAI&quot;</span><span class="p">,</span> <span class="s2">&quot;RP100_EAI&quot;</span><span class="p">,</span> <span class="s2">&quot;RP1000_EAI&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI%&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>

    <span class="c1"># Round to three decimal places to avoid giving the impression of high precision</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Write table of total population in each class, in each ADM2</span>
    <span class="n">df_cols</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">no_geom</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df_cols</span><span class="p">[</span><span class="o">~</span><span class="n">df_cols</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;geometry&#39;</span><span class="p">])]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
        <span class="n">no_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_EAI.gpkg&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
        <span class="n">no_geom</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_class.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_FL_</span><span class="si">{</span><span class="n">adm_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s2">_class.gpkg&quot;</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished analysis.&quot;</span><span class="p">)</span>
        <span class="n">rb</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">preview_chk</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s1">_EAI&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">))</span>

                <span class="n">exp_total</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s1">_tot&#39;</span><span class="p">)</span>
                <span class="n">exp_imp</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s1">_imp&#39;</span><span class="p">)</span>
                <span class="n">exp_EAI</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s1">_EAI&#39;</span><span class="p">)</span>
                
                <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
                <span class="c1"># TODO: C1 Column selected for example display only!</span>
                <span class="n">display</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;RP10_</span><span class="si">{</span><span class="n">exp_cat</span><span class="si">}</span><span class="s1">_C1&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data option widgets</span>
<span class="n">country_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Nepal&#39;</span><span class="p">,</span> <span class="s1">&#39;NPL&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Pakistan&#39;</span><span class="p">,</span> <span class="s1">&#39;PAK&#39;</span><span class="p">),(</span><span class="s1">&#39;Bangladesh&#39;</span><span class="p">,</span> <span class="s1">&#39;BGD&#39;</span><span class="p">),(</span><span class="s1">&#39;Ghana&#39;</span><span class="p">,</span> <span class="s1">&#39;GHA&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Ethiopia&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Burkina Faso&#39;</span><span class="p">,</span> <span class="s1">&#39;BFA&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Mali&#39;</span><span class="p">,</span> <span class="s1">&#39;MLI&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Niger&#39;</span><span class="p">,</span> <span class="s1">&#39;NER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Chad&#39;</span><span class="p">,</span> <span class="s1">&#39;TCD&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Mauritania&#39;</span><span class="p">,</span> <span class="s1">&#39;MRT&#39;</span><span class="p">)],</span>
    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;NPL&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Country:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">exp_cat_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="s2">&quot;pop&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Built-up&quot;</span><span class="p">,</span> <span class="s2">&quot;builtup&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Agriculture&quot;</span><span class="p">,</span> <span class="s2">&quot;agri&quot;</span><span class="p">)],</span>
    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Exposure Category:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">adm_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM2&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM3&#39;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;ADM2&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Administrative Unit Level:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">min_haz_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum Hazard Threshold:&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Class value inputs</span>
<span class="n">class_edges</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
    <span class="sa">f</span><span class="s1">&#39;class_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">widgets</span><span class="o">.</span><span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span>
        <span class="n">tooltip</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Minimum value of class </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Value must be less than the next entry.&#39;</span><span class="p">,</span>
        <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="p">})</span>

<span class="c1"># Climate component (in addition to baseline risk - load external module)</span>

<span class="n">time_horizon_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">2040</span><span class="p">,</span> <span class="mi">2060</span><span class="p">,</span> <span class="mi">2080</span><span class="p">,</span> <span class="mi">2100</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="mi">2060</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Time Horizon:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">rcp_scenario_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;2.6&quot;</span><span class="p">,</span> <span class="s2">&quot;4.5&quot;</span><span class="p">,</span> <span class="s2">&quot;8.5&quot;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;4.5&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;RCP Scenario:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">analysis_app_dd</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Classes&quot;</span><span class="p">,</span> <span class="s2">&quot;Function&quot;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Function&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Analysis Approach:&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># User action widgets</span>
<span class="n">save_inter_rst_chk</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Export Intermediate Rasters&#39;</span><span class="p">,</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Save rasters generated between each step (saves to nominated output directory)&#39;</span><span class="p">,</span>
    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">indent</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Display results after runs</span>
<span class="n">preview_chk</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Preview results&#39;</span><span class="p">,</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Display result after analysis&#39;</span><span class="p">,</span>
    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>


<span class="c1"># Run button to perform analysis</span>
<span class="n">run_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Run Analysis&#39;</span><span class="p">,</span>
    <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># &#39;success&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;danger&#39; or &#39;&#39;</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Click to run analysis with selected options&#39;</span><span class="p">,</span>
    <span class="c1"># icon=&#39;check&#39; # (FontAwesome names without the `fa-` prefix)</span>
<span class="p">)</span>


<span class="c1"># Button to preview hazard impact function</span>
<span class="n">preview_impact_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Preview Impact Function&#39;</span><span class="p">,</span>
    <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># &#39;success&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;danger&#39; or &#39;&#39;</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Show preview of impact function&#39;</span><span class="p">,</span>
    <span class="c1"># icon=&#39;check&#39; # (FontAwesome names without the `fa-` prefix)</span>
<span class="p">)</span>

<span class="n">reset_display_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Reset&#39;</span><span class="p">,</span>
    <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># &#39;success&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;danger&#39; or &#39;&#39;</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="s1">&#39;Reset display&#39;</span><span class="p">,</span>
    <span class="c1"># icon=&#39;check&#39; # (FontAwesome names without the `fa-` prefix)</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">reset_display</span><span class="p">(</span><span class="n">bt</span><span class="p">):</span>
    <span class="n">output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="n">run_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">analysis_app_dd</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
        <span class="n">preview_impact_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">run_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">run_analysis</span><span class="p">)</span>
<span class="n">preview_impact_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">preview_impact_func</span><span class="p">)</span>
<span class="n">reset_display_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">reset_display</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">analysis_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Classes&quot;</span><span class="p">:</span>
        <span class="n">min_haz_slider</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preview_impact_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preview_chk</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preview_chk</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">disable_class</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_haz_slider</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">preview_impact_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">preview_chk</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">preview_chk</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">disable_class</span> <span class="o">=</span> <span class="kc">True</span>
        
    
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">class_edges</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">w</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">disable_class</span>

<span class="n">analysis_app_dd</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">analysis_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>


<span class="c1"># preview_button.on_click()</span>

<span class="c1"># class_range = range(3, 11)  # remember that python uses end-exclusive range, so this is 3-10</span>
<span class="c1"># selected_bin_edges = [0.5, 1, 1.5, 2, 2.5, 3]</span>
<span class="c1"># min_haz_threshold = np.min(selected_bin_edges)  # determine min/max values from user-selected edges</span>
<span class="c1"># max_haz_threshold = np.max(selected_bin_edges)</span>
<span class="c1"># selected_bin_edges += [np.inf] # add inf last to cover anything above max threshold.</span>

<span class="c1"># num_bins = len(selected_bin_edges)-1  # default number of bins, within the range of `class_range`</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">country_dd</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">exp_cat_dd</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">adm_dd</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">analysis_app_dd</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">min_haz_slider</span><span class="p">)</span>
<span class="p">[</span><span class="n">display</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">class_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

<span class="n">display</span><span class="p">(</span><span class="n">HBox</span><span class="p">([</span><span class="n">run_button</span><span class="p">,</span> <span class="n">preview_chk</span><span class="p">,</span> <span class="n">save_inter_rst_chk</span><span class="p">]),</span> 
        <span class="n">preview_impact_button</span><span class="p">,</span> <span class="n">reset_display_button</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9cb2833df2b542aaab42bc3122dc48ae", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "33d5034cbbfb4c08b6c6ce8e1abc4327", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d08afe60865d4227ac78fcfae979f0dc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9e2d2009cd084c2385079d4f4dce51a0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d469d4657d9447f0bf97514dbc9d9c8f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a350def7d3bd4f068baf9d9384e7d845", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "20a3075f5dfb48d0a7bb80c954fa189c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b29b5df2f9784802a32c6e99434f205e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "27f264c9aba44dc382da7aab0465ffb1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "72990be6e3dd4b0b878d1dad59f3a189", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "17dd4fb4cdb2476980af2b7f83485cb3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "05029e047adb463596f7ca2f578efe21", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e02f5592e3684e5a9ce824256fb40c3d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cc3aa2ce53834de9ba77beeb07f93694", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "be89bc9eba54485f9de03336ecffb6a2", "version_major": 2, "version_minor": 0}
</script></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Top-down/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../procedures/Analytical_procedure_function.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Expected Annual Impact (EAI)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../procedures/Analytical_procedure_classes.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Expected Annual Exposure (EAE)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By M. Amadio (GFDRR)<br/>
  
    Last updated on Apr 14, 2023.<br/>
    <div class="extra_footer">
      <div>
    <b>All content (unless otherwise specified) is subject to the <a href="https://raw.githubusercontent.com/worldbank/template/main/LICENSE">World Bank Master Community License Agreement.</a></b>
</div>

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>