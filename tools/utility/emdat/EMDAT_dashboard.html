
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>EMDAT Disaster Data Dashboard - Enhanced with Leafmap &#8212; Climate &amp; Disaster Risk Screening Tools</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=4ec06e9971c5264fbd345897d5258098f11cc577" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/extra.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=8bf782fb4ee92b3d3646425e50f299c4e1fd152d"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tools/utility/emdat/EMDAT_dashboard';</script>
    <link rel="canonical" href="https://GFDRR.github.io/CCDR-tools/tools/utility/emdat/EMDAT_dashboard.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="The Philosophy of Mapping" href="../../../docs/philosophy_of_mapping.html" />
    <link rel="prev" title="Mapping &amp; Geocoding" href="../mapping.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../home.html">

  
  
  
  
  
  
  

  
    <img src="../../../_static/logo_flat.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/logo_flat.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-hazard.html">
                        Natural hazards
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-exposure.html">
                        Exposure
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-vulnerability.html">
                        Vulnerability
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-risk.html">
                        Impact and risk
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/climate-risk.html">
                        Climate change and disaster risk
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-hazard.html">
                        Hazard datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-exposure.html">
                        Exposure datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-vulnerability.html">
                        Vulnerability models
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/risk-poverty.html">
                        Risk and poverty
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/disaster-data.html">
                        Disaster records
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/rdl.html">
                        Risk Data Library
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/external-tools.html">
                        Additional resources
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/tool-setup.html">
                        Tool setup and run
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/validation.html">
                        Validation and interpretation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/presentation.html">
                        Results presentation
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../../../docs/utility.html">
                        Utilities
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/philosophy_of_mapping.html">
                        The Philosophy of Mapping
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/team.html">
                        Team and Acknowledgements
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-hazard.html">
                        Natural hazards
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-exposure.html">
                        Exposure
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-vulnerability.html">
                        Vulnerability
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/intro-risk.html">
                        Impact and risk
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/climate-risk.html">
                        Climate change and disaster risk
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-hazard.html">
                        Hazard datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-exposure.html">
                        Exposure datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/global-vulnerability.html">
                        Vulnerability models
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/risk-poverty.html">
                        Risk and poverty
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/disaster-data.html">
                        Disaster records
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/rdl.html">
                        Risk Data Library
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/external-tools.html">
                        Additional resources
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/tool-setup.html">
                        Tool setup and run
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/validation.html">
                        Validation and interpretation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/presentation.html">
                        Results presentation
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../../../docs/utility.html">
                        Utilities
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/philosophy_of_mapping.html">
                        The Philosophy of Mapping
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../docs/team.html">
                        Team and Acknowledgements
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
  


<a class="navbar-brand logo" href="../../../home.html">

  
  
  
  
  
  
  

  
    <img src="../../../_static/logo_flat.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/logo_flat.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    </div>
    <div class="sidebar-start-items__item">
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Disaster Risk Concepts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/intro-hazard.html">Natural hazards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/intro-exposure.html">Exposure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/intro-vulnerability.html">Vulnerability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/intro-risk.html">Impact and risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/climate-risk.html">Climate change and disaster risk</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Global Risk Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../docs/global-hazard.html">Hazard datasets</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/hzd_gp-data.html">Geophysical hazards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/hzd_hm-data.html">Hydro-Meteorological hazards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/hzd_env-data.html">Environmental factors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/global-exposure.html">Exposure datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/global-vulnerability.html">Vulnerability models</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../docs/risk-poverty.html">Risk and poverty</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/disaster-data.html">Disaster records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/rdl.html">Risk Data Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/external-tools.html">Additional resources</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Disaster Risk Analytics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../docs/tool-setup.html">Tool setup and run</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/run_fl.html">Flood Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/run_tc.html">Tropical Cyclone Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/run_ch.html">Custom Hazard Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/run_ci.html">Climate Indices Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docs/run_bv.html">Bivariate mapping of Risk and Poverty</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/validation.html">Validation and interpretation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/presentation.html">Results presentation</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../../docs/utility.html">Utilities</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../docs/philosophy_of_mapping.html">The Philosophy of Mapping</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Credits</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/team.html">Team and Acknowledgements</a></li>
</ul>

    </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        <label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" data-toggle="tooltip" data-placement="right" title="Toggle primary sidebar">
            <span class="fa-solid fa-bars"></span>
        </label>
    </div>
    <div class="header-article__right">


<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
  </ul>
</div>

<button onclick="toggleFullScreen()"
  class="btn btn-sm"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<div class="dropdown dropdown-repository-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      <li><a href="https://github.com/GFDRR/CCDR-tools" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">repository</span>
</a>
</a>
      
      <li><a href="https://github.com/GFDRR/CCDR-tools/issues/new?title=Issue%20on%20page%20%2Ftools/utility/emdat/EMDAT_dashboard.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">open issue</span>
</a>
</a>
      
      <li><a href="https://github.com/GFDRR/CCDR-tools/edit/main/tools/utility/emdat/EMDAT_dashboard.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">suggest edit</span>
</a>
</a>
      
  </ul>
</div>



<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      <li><a href="../../../_sources/tools/utility/emdat/EMDAT_dashboard.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</a>
      
      <li>
<button onclick="printPdf(this)"
  class="btn btn-sm dropdown-item"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</a>
      
  </ul>
</div>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary" data-toggle="tooltip" data-placement="left" title="Toggle secondary sidebar">
            <span class="fa-solid fa-list"></span>
        </label>
    </div>
</div>
            </div>
            
            

<div id="jb-print-docs-body" class="onlyprint">
    <h1>EMDAT Disaster Data Dashboard - Enhanced with Leafmap</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-dashboard-with-quantile-based-choropleth-maps">
   Interactive Dashboard with Quantile-Based Choropleth Maps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#features">
     Features:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#required-input">
     Required input:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#usage-tips">
     Usage Tips:
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>

            <article class="bd-article" role="main">
              
  <section class="tex2jax_ignore mathjax_ignore" id="emdat-disaster-data-dashboard-enhanced-with-leafmap">
<h1>EMDAT Disaster Data Dashboard - Enhanced with Leafmap<a class="headerlink" href="#emdat-disaster-data-dashboard-enhanced-with-leafmap" title="Permalink to this heading">#</a></h1>
<section id="interactive-dashboard-with-quantile-based-choropleth-maps">
<h2>Interactive Dashboard with Quantile-Based Choropleth Maps<a class="headerlink" href="#interactive-dashboard-with-quantile-based-choropleth-maps" title="Permalink to this heading">#</a></h2>
<p>This dashboard provides comprehensive analysis of EMDAT disaster data with enhanced subnational visualization using Leafmap for superior legend control and quantile-based classification.</p>
<section id="features">
<h3>Features:<a class="headerlink" href="#features" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Country Selection</strong>: Choose specific countries or view global data, administrative levels: ADM1 and ADM2</p></li>
<li><p><strong>Time Range Filtering</strong>: Adjust the year range using the slider</p></li>
<li><p><strong>Multiple Visualization Tabs</strong>: Overview, disaster types, temporal trends, loss analysis, and subnational analysis</p></li>
<li><p><strong>Choropleth Maps</strong>: Quantile-based classification (5 classes) for multiple metrics: Deaths, Affected Population, Disaster Count.</p></li>
</ul>
</section>
<section id="required-input">
<h3>Required input:<a class="headerlink" href="#required-input" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>EMDAT database</strong>: download the latest global dataset of natural disasters from <a class="reference external" href="https://www.emdat.be/"><strong>EMDAT</strong></a> or use this export: <a class="reference external" href="https://github.com/GFDRR/CCDR-tools/raw/refs/heads/main/tools/utility/emdat/emdat_2025.xlsx"><strong>emdat_2025.xlsx</strong></a></p></li>
<li><p><strong>ADM units boundaries</strong>: EMDAT geomapping is based on <a class="reference external" href="https://data.amerigeoss.org/it/dataset/global-administrative-boundaries-regions-gaul-2015"><strong>GAUL 2015</strong></a> dataset. A refined version of the dataset produced for this tool is available here: <a class="reference external" href="https://github.com/GFDRR/CCDR-tools/raw/refs/heads/main/tools/utility/emdat/ADM_GAUL.gpkg"><strong>ADM_GAUL.gpkg</strong></a></p></li>
</ol>
</section>
<section id="usage-tips">
<h3>Usage Tips:<a class="headerlink" href="#usage-tips" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>For best choropleth results</strong>: Select countries with high subnational data coverage</p></li>
<li><p><strong>Legend management</strong>: Toggle layers on/off to show only relevant legends</p></li>
<li><p><strong>Interactive maps</strong>: Click on administrative units for detailed information</p></li>
<li><p><strong>Performance</strong>: Large datasets may take a few seconds to render choropleth maps</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## CONFIGURATION PARAMETERS</span>
<span class="n">EXCEL_FILE_PATH</span> <span class="o">=</span> <span class="s1">&#39;emdat_2025.xlsx&#39;</span>  <span class="c1"># Set your EMDAT Excel file path here</span>
<span class="n">GPKG_FILE_PATH</span> <span class="o">=</span> <span class="s1">&#39;X:/Work/Geodata/ADM/ADM_GAUL.gpkg&#39;</span>  <span class="c1"># Set your ADM units GPKG file path here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">clear_output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Optional: For advanced mapping</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
    <span class="n">GEOPANDAS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ GeoPandas available - choropleth maps enabled&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">GEOPANDAS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ GeoPandas not available - install with: pip install geopandas&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
    <span class="n">SCIPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SCIPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SciPy not installed. Some trend analysis features will be limited.&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EMDATDashboard</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class for EMDAT disaster data dashboard&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize dashboard with EMDAT Excel file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">excel_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_country</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load EMDAT data from Excel file&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data loaded successfully!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Years covered: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Countries: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disaster types: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please ensure your EMDAT Excel file is in the correct location&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean and prepare the data for analysis&quot;&quot;&quot;</span>
        <span class="c1"># Handle missing values</span>
        <span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;No Injured&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;No Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;No Homeless&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Insured Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">,</span> <span class="s1">&#39;Reconstruction Costs (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Create decade column for temporal analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Decade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        
        <span class="c1"># Create simplified disaster categories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorize_disaster</span><span class="p">)</span>
        
        <span class="c1"># Calculate total losses (deaths + affected)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Losses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data preparation completed!&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">categorize_disaster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disaster_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Categorize disasters into broader groups&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">disaster_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>
        
        <span class="n">disaster_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">disaster_type</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">disaster_type</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flood&#39;</span><span class="p">,</span> <span class="s1">&#39;storm&#39;</span><span class="p">,</span> <span class="s1">&#39;cyclone&#39;</span><span class="p">,</span> <span class="s1">&#39;hurricane&#39;</span><span class="p">,</span> <span class="s1">&#39;typhoon&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;Hydrometeorological&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">disaster_type</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;earthquake&#39;</span><span class="p">,</span> <span class="s1">&#39;volcanic&#39;</span><span class="p">,</span> <span class="s1">&#39;landslide&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;Geophysical&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">disaster_type</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;drought&#39;</span><span class="p">,</span> <span class="s1">&#39;extreme temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;wildfire&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;Climatological&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">disaster_type</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;epidemic&#39;</span><span class="p">,</span> <span class="s1">&#39;infestation&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;Biological&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_admin_units</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the JSON-formatted Admin Units string&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">admin_units_str</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">admin_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">admin_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">admin_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
            <span class="n">admin_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">admin_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">admin_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">admin_data</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">admin_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">admin_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
            <span class="n">admin_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">admin_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">admin_data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">admin_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">admin_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">admin_data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">admin_data</span><span class="p">]</span>
            
    <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Fallback to regex parsing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adm1_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;adm1_name&quot;\s*:\s*&quot;([^&quot;]+)&quot;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">))</span>
            <span class="n">adm1_codes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;adm1_code&quot;\s*:\s*(\d+)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">))</span>
            <span class="n">adm2_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;adm2_name&quot;\s*:\s*&quot;([^&quot;]+)&quot;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">))</span>
            <span class="n">adm2_codes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;adm2_code&quot;\s*:\s*(\d+)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_units_str</span><span class="p">))</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adm1_matches</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">adm1_codes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">adm1_codes</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;adm1_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;adm1_code&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">})</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adm2_matches</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">adm2_codes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">adm2_codes</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;adm2_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;adm2_code&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">})</span>
            
            <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">[]</span>
                
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># DYNAMIC COUNTRY MAPPINGS FROM BOUNDARY FILE</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Global cache for country mappings to avoid reading file multiple times</span>
<span class="n">_country_mappings_cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_country_mappings_from_boundaries</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build dynamic country mappings from the ADM_0 layer in the boundary file.</span>
<span class="sd">    Returns iso_to_gaul and iso_to_names mappings extracted from the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_country_mappings_cache</span>
    
    <span class="c1"># Check if mappings are already cached</span>
    <span class="k">if</span> <span class="n">gpkg_file_path</span> <span class="ow">in</span> <span class="n">_country_mappings_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_country_mappings_cache</span><span class="p">[</span><span class="n">gpkg_file_path</span><span class="p">]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📚 Building dynamic country mappings from </span><span class="si">{</span><span class="n">gpkg_file_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if ADM_0 layer exists</span>
        <span class="n">available_layers</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">list_layers</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">available_layers</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span>
        
        <span class="c1"># Try different possible ADM_0 layer names</span>
        <span class="n">adm0_layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADM_0&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_0&#39;</span><span class="p">,</span> <span class="s1">&#39;level_0&#39;</span><span class="p">,</span> <span class="s1">&#39;countries&#39;</span><span class="p">]</span>
        <span class="n">adm0_layer</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">adm0_layer_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
                <span class="n">adm0_layer</span> <span class="o">=</span> <span class="n">layer_name</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adm0_layer</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ⚠️ No ADM_0 layer found in available layers: </span><span class="si">{</span><span class="n">layer_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="c1"># Read ADM_0 layer</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    📂 Reading </span><span class="si">{</span><span class="n">adm0_layer</span><span class="si">}</span><span class="s2"> layer...&quot;</span><span class="p">)</span>
        <span class="n">adm0_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">adm0_layer</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    📊 Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adm0_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> country records&quot;</span><span class="p">)</span>
        
        <span class="c1"># Show available columns for debugging</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Available columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">adm0_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize mappings</span>
        <span class="n">iso_to_gaul</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">iso_to_names</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Define possible column name variations</span>
        <span class="n">iso_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ISO3166_a3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO_a3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">]</span>
        <span class="n">gaul_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADM0_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUL_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUL&#39;</span><span class="p">]</span>
        <span class="n">name_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADM0_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_EN&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTRY&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_NAME_EN&#39;</span><span class="p">]</span>
        
        <span class="c1"># Find the actual column names</span>
        <span class="n">iso_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gaul_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name_col</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">iso_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">adm0_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">iso_col</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gaul_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">adm0_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">gaul_col</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">name_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">adm0_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">name_col</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🎯 Using columns - ISO: </span><span class="si">{</span><span class="n">iso_col</span><span class="si">}</span><span class="s2">, GAUL: </span><span class="si">{</span><span class="n">gaul_col</span><span class="si">}</span><span class="s2">, NAME: </span><span class="si">{</span><span class="n">name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iso_col</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ No ISO column found in </span><span class="si">{</span><span class="n">iso_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gaul_col</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ No GAUL code column found in </span><span class="si">{</span><span class="n">gaul_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_col</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ No name column found in </span><span class="si">{</span><span class="n">name_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="c1"># Build mappings from the data</span>
        <span class="n">mapping_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adm0_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">iso_code</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">iso_col</span><span class="p">)</span>
            <span class="n">gaul_code</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gaul_col</span><span class="p">)</span>
            <span class="n">country_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_col</span><span class="p">)</span>
            
            <span class="c1"># Skip rows with missing essential data</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">iso_code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">gaul_code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">country_name</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># Clean and standardize the values</span>
            <span class="n">iso_code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iso_code</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">gaul_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gaul_code</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">gaul_code</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">country_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">country_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Only process valid ISO codes (3 characters)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso_code</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">gaul_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iso_to_gaul</span><span class="p">[</span><span class="n">iso_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaul_code</span>
                
                <span class="c1"># Store country name as a list for consistency with original structure</span>
                <span class="n">iso_to_names</span><span class="p">[</span><span class="n">iso_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">country_name</span><span class="p">]</span>
                <span class="n">mapping_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ Built mappings for </span><span class="si">{</span><span class="n">mapping_count</span><span class="si">}</span><span class="s2"> countries&quot;</span><span class="p">)</span>
        
        <span class="c1"># Cache the results</span>
        <span class="n">_country_mappings_cache</span><span class="p">[</span><span class="n">gpkg_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iso_to_gaul</span><span class="p">,</span> <span class="n">iso_to_names</span><span class="p">)</span>
        
        <span class="c1"># Show sample mappings for verification</span>
        <span class="n">sample_isos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iso_to_gaul</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    📋 Sample mappings:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">sample_isos</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">: GAUL=</span><span class="si">{</span><span class="n">iso_to_gaul</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="si">}</span><span class="s2">, NAME=</span><span class="si">{</span><span class="n">iso_to_names</span><span class="p">[</span><span class="n">iso</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">iso_to_gaul</span><span class="p">,</span> <span class="n">iso_to_names</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ Error building country mappings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_country_boundaries_robust</span><span class="p">(</span><span class="n">boundaries_gdf</span><span class="p">,</span> <span class="n">country_iso</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get country boundaries using multiple fallback methods - DYNAMIC VERSION&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🔍 Searching for </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> boundaries using dynamic mappings...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Method 1: Try ISO_a3 field (most common)</span>
        <span class="k">if</span> <span class="s1">&#39;ISO_a3&#39;</span> <span class="ow">in</span> <span class="n">boundaries_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Trying ISO_a3 field...&quot;</span><span class="p">)</span>
            <span class="n">country_boundaries</span> <span class="o">=</span> <span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">boundaries_gdf</span><span class="p">[</span><span class="s1">&#39;ISO_a3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_iso</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">country_boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries using ISO_a3&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">country_boundaries</span>
        
        <span class="c1"># Method 2: Try other ISO fields</span>
        <span class="k">for</span> <span class="n">iso_field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ISO3166_a3&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO3&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTRY_ISO&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">iso_field</span> <span class="ow">in</span> <span class="n">boundaries_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Trying </span><span class="si">{</span><span class="n">iso_field</span><span class="si">}</span><span class="s2"> field...&quot;</span><span class="p">)</span>
                <span class="n">country_boundaries</span> <span class="o">=</span> <span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">iso_field</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">country_iso</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">country_boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries using </span><span class="si">{</span><span class="n">iso_field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">country_boundaries</span>
        
        <span class="c1"># Method 3: Try ADM0_NAME with DYNAMIC country mapping</span>
        <span class="k">if</span> <span class="s1">&#39;ADM0_NAME&#39;</span> <span class="ow">in</span> <span class="n">boundaries_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">gpkg_file_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Trying ADM0_NAME field with dynamic country name mapping...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Get dynamic mappings from the boundary file</span>
            <span class="n">iso_to_gaul</span><span class="p">,</span> <span class="n">iso_to_names</span> <span class="o">=</span> <span class="n">build_country_mappings_from_boundaries</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">iso_to_names</span> <span class="ow">and</span> <span class="n">country_iso</span> <span class="ow">in</span> <span class="n">iso_to_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">country_name_variant</span> <span class="ow">in</span> <span class="n">iso_to_names</span><span class="p">[</span><span class="n">country_iso</span><span class="p">]:</span>
                    <span class="n">country_boundaries</span> <span class="o">=</span> <span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">boundaries_gdf</span><span class="p">[</span><span class="s1">&#39;ADM0_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">country_name_variant</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">country_boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries using ADM0_NAME: </span><span class="si">{</span><span class="n">country_name_variant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">country_boundaries</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ⚠️ Dynamic name mapping not available or </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="c1"># Method 4: Try GAUL codes with DYNAMIC mapping</span>
        <span class="k">if</span> <span class="s1">&#39;ADM0_CODE&#39;</span> <span class="ow">in</span> <span class="n">boundaries_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">gpkg_file_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Trying GAUL codes with dynamic mapping...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Get dynamic mappings from the boundary file  </span>
            <span class="n">iso_to_gaul</span><span class="p">,</span> <span class="n">iso_to_names</span> <span class="o">=</span> <span class="n">build_country_mappings_from_boundaries</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">iso_to_gaul</span> <span class="ow">and</span> <span class="n">country_iso</span> <span class="ow">in</span> <span class="n">iso_to_gaul</span><span class="p">:</span>
                <span class="n">gaul_code</span> <span class="o">=</span> <span class="n">iso_to_gaul</span><span class="p">[</span><span class="n">country_iso</span><span class="p">]</span>
                <span class="n">country_boundaries</span> <span class="o">=</span> <span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">boundaries_gdf</span><span class="p">[</span><span class="s1">&#39;ADM0_CODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gaul_code</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">country_boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries using dynamic GAUL code: </span><span class="si">{</span><span class="n">gaul_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">country_boundaries</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ⚠️ Dynamic GAUL mapping not available or </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ No boundaries found for </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> using any method&quot;</span><span class="p">)</span>
        
        <span class="c1"># Debug: Show available country identifiers</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🔍 Debug - Available fields in GPKG:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ADM0_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;ADM0_A3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO_a3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO3166_a3&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO3&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">boundaries_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">sample_values</span> <span class="o">=</span> <span class="n">boundaries_gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sample_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ Error in dynamic boundary matching: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_merged_boundary_data</span><span class="p">(</span><span class="n">admin_data</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">country_iso</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create merged boundary data - DYNAMIC VERSION with improved country matching&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Determine GPKG layer and code column</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;ADM1&#39;</span><span class="p">:</span>
            <span class="n">gpkg_layer</span> <span class="o">=</span> <span class="s1">&#39;ADM_1&#39;</span>
            <span class="n">code_col</span> <span class="o">=</span> <span class="s1">&#39;ADM1_CODE&#39;</span>
            <span class="n">name_col</span> <span class="o">=</span> <span class="s1">&#39;ADM1_NAME&#39;</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;ADM2&#39;</span><span class="p">:</span>
            <span class="n">gpkg_layer</span> <span class="o">=</span> <span class="s1">&#39;ADM_2&#39;</span>
            <span class="n">code_col</span> <span class="o">=</span> <span class="s1">&#39;ADM2_CODE&#39;</span>
            <span class="n">name_col</span> <span class="o">=</span> <span class="s1">&#39;ADM2_NAME&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ Unsupported admin level: </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📂 Loading </span><span class="si">{</span><span class="n">gpkg_layer</span><span class="si">}</span><span class="s2"> boundaries for </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if the layer exists in the GPKG file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">available_layers</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">list_layers</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">available_layers</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span>
            
            <span class="k">if</span> <span class="n">gpkg_layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ Layer </span><span class="si">{</span><span class="n">gpkg_layer</span><span class="si">}</span><span class="s2"> not found in GPKG&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📋 Available layers: </span><span class="si">{</span><span class="n">layer_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Try alternative layer names</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;ADM_1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_1&#39;</span><span class="p">,</span> <span class="s1">&#39;adm1&#39;</span><span class="p">,</span> <span class="s1">&#39;level_1&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ADM_2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ADM2&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_2&#39;</span><span class="p">,</span> <span class="s1">&#39;adm2&#39;</span><span class="p">,</span> <span class="s1">&#39;level_2&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="n">gpkg_layer</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">[</span><span class="n">gpkg_layer</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🔄 Using alternative layer name: </span><span class="si">{</span><span class="n">alt_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">gpkg_layer</span> <span class="o">=</span> <span class="n">alt_name</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ No suitable alternative layer found&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️ Could not check layer availability: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">boundaries_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">gpkg_layer</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📊 Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boundaries_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries from </span><span class="si">{</span><span class="n">gpkg_layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get country boundaries using DYNAMIC method</span>
        <span class="n">country_boundaries</span> <span class="o">=</span> <span class="n">get_country_boundaries_robust</span><span class="p">(</span><span class="n">boundaries_gdf</span><span class="p">,</span> <span class="n">country_iso</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">country_boundaries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ No boundaries found for </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">gpkg_layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">country_boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> boundaries&quot;</span><span class="p">)</span>
        
        <span class="c1"># Aggregate admin data</span>
        <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Admin Unit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">admin_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Damage&#39;</span><span class="p">,</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">]</span>
        
        <span class="c1"># Remove null codes and convert to string</span>
        <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="p">[</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">country_boundaries</span><span class="p">[</span><span class="n">code_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">country_boundaries</span><span class="p">[</span><span class="n">code_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Merge with boundaries</span>
        <span class="n">merged_data</span> <span class="o">=</span> <span class="n">country_boundaries</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">admin_summary</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="n">code_col</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;Admin Code&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Fill NaN values</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Damage&#39;</span><span class="p">,</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">]:</span>
            <span class="n">merged_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Add admin names from boundaries if missing</span>
        <span class="k">if</span> <span class="n">name_col</span> <span class="ow">in</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="n">name_col</span><span class="p">])</span>
        
        <span class="n">matched_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Matched </span><span class="si">{</span><span class="n">matched_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> boundaries with disaster data&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">merged_data</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ Error creating merged boundary data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># UPDATED CHOROPLETH FUNCTION WITH DYNAMIC MAPPINGS</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_working_multi_layer_choropleth</span><span class="p">(</span><span class="n">admin_df</span><span class="p">,</span> <span class="n">original_df</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DYNAMIC VERSION: Create a working multi-layer choropleth map with 6 layers</span>
<span class="sd">    using dynamic country mappings from the boundary file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">GEOPANDAS_AVAILABLE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ GeoPandas required for choropleth maps&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ GPKG file not found: </span><span class="si">{</span><span class="n">gpkg_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No admin data available&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
    
    <span class="n">country_iso</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">country_name</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🗺️ Creating DYNAMIC multi-layer choropleth for </span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Build dynamic country mappings from boundary file</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📚 Building dynamic country mappings...&quot;</span><span class="p">)</span>
    <span class="n">iso_to_gaul</span><span class="p">,</span> <span class="n">iso_to_names</span> <span class="o">=</span> <span class="n">build_country_mappings_from_boundaries</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">iso_to_gaul</span> <span class="ow">and</span> <span class="n">country_iso</span> <span class="ow">in</span> <span class="n">iso_to_gaul</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Found dynamic mapping: </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2"> -&gt; GAUL </span><span class="si">{</span><span class="n">iso_to_gaul</span><span class="p">[</span><span class="n">country_iso</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">iso_to_names</span><span class="p">[</span><span class="n">country_iso</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️ No dynamic mapping found for </span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2">, will use fallback methods&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add comprehensive boundary file debugging info</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📂 Checking boundary file: </span><span class="si">{</span><span class="n">gpkg_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">available_layers</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">list_layers</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">available_layers</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="n">available_layers</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📋 Available layers: </span><span class="si">{</span><span class="n">layer_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Quick column check for ADM_1</span>
        <span class="k">if</span> <span class="s1">&#39;ADM_1&#39;</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
            <span class="n">sample_adm1</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;ADM_1&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🔍 Sample ADM_1 columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">sample_adm1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️ Could not analyze boundary file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># STEP 1: Prepare data by admin level</span>
        <span class="n">adm1_data</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Admin Level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADM1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">adm2_data</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Admin Level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ADM2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Get merged boundary data for each level using DYNAMIC method</span>
        <span class="n">merged_datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adm1_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🏛️ Processing ADM1 data (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adm1_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> records)...&quot;</span><span class="p">)</span>
            <span class="n">adm1_merged</span> <span class="o">=</span> <span class="n">create_merged_boundary_data</span><span class="p">(</span><span class="n">adm1_data</span><span class="p">,</span> <span class="s1">&#39;ADM1&#39;</span><span class="p">,</span> <span class="n">country_iso</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adm1_merged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">adm1_merged</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adm1_merged</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ ADM1 merged successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ ADM1 merge failed&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adm2_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🏛️ Processing ADM2 data (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adm2_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> records)...&quot;</span><span class="p">)</span>
            <span class="n">adm2_merged</span> <span class="o">=</span> <span class="n">create_merged_boundary_data</span><span class="p">(</span><span class="n">adm2_data</span><span class="p">,</span> <span class="s1">&#39;ADM2&#39;</span><span class="p">,</span> <span class="n">country_iso</span><span class="p">,</span> <span class="n">country_name</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adm2_merged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">adm2_merged</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adm2_merged</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ ADM2 merged successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ ADM2 merge failed&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_datasets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No merged boundary data available - check GPKG file and country codes&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💡 Country: </span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💡 GPKG file: </span><span class="si">{</span><span class="n">gpkg_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Successfully merged </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> admin levels using DYNAMIC mappings&quot;</span><span class="p">)</span>
        
        <span class="c1"># Continue with the rest of the choropleth creation (same as before)...</span>
        <span class="c1"># [Rest of the function remains unchanged - just using the dynamic merged data]</span>
        
        <span class="c1"># STEP 2: Create base map with proper setup</span>
        <span class="c1"># Calculate center from first available dataset</span>
        <span class="n">first_dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">merged_datasets</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">first_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ First dataset is None&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
        
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">first_dataset</span><span class="o">.</span><span class="n">total_bounds</span>
        <span class="n">center_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Calculate zoom</span>
        <span class="n">lat_range</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lon_range</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">)</span>
        <span class="n">zoom</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">max_range</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="k">else</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">max_range</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="k">else</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">max_range</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">7</span>
        
        <span class="c1"># Initialize map without default tiles</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
            <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">center_lat</span><span class="p">,</span> <span class="n">center_lon</span><span class="p">],</span>
            <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
            <span class="n">tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Add base tile layers</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">(</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Street Map&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">(</span><span class="s1">&#39;CartoDB positron&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Light Map&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">(</span><span class="s1">&#39;CartoDB dark_matter&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dark Map&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Base map created at (</span><span class="si">{</span><span class="n">center_lat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">center_lon</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">), zoom: </span><span class="si">{</span><span class="n">zoom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># STEP 3: Define layer configurations</span>
        <span class="n">layer_configs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Add ADM1 layers if data exists</span>
        <span class="k">if</span> <span class="s1">&#39;ADM1&#39;</span> <span class="ow">in</span> <span class="n">merged_datasets</span><span class="p">:</span>
            <span class="n">layer_configs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM1 - Deaths&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Show first layer by default</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.7</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM1 - Affected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM1 - Disasters&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM1&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
                <span class="p">}</span>
            <span class="p">])</span>
        
        <span class="c1"># Add ADM2 layers if data exists</span>
        <span class="k">if</span> <span class="s1">&#39;ADM2&#39;</span> <span class="ow">in</span> <span class="n">merged_datasets</span><span class="p">:</span>
            <span class="n">layer_configs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM2 - Deaths&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.7</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM2 - Affected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM2 - Disasters&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">merged_datasets</span><span class="p">[</span><span class="s1">&#39;ADM2&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color_scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
                <span class="p">}</span>
            <span class="p">])</span>
        
        <span class="c1"># STEP 4: Create FeatureGroups and choropleth layers</span>
        <span class="n">layers_created</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">legend_top_position</span> <span class="o">=</span> <span class="mi">80</span>  <span class="c1"># Start position</span>
        <span class="n">compact_spacing</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Reduced spacing for compact legends</span>
        
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">layer_configs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if we have data for this metric</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️ No data for </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🎨 Creating </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2"> areas, range </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Create FeatureGroup for this layer</span>
                <span class="n">fg</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Checkbox behavior</span>
                    <span class="n">show</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                
                <span class="c1"># Calculate quantile bins for this specific metric</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span> <span class="k">if</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                
                <span class="n">bins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bins</span><span class="p">)))</span>  <span class="c1"># Remove duplicates</span>
                
                <span class="c1"># Prepare data for choropleth (reset index to avoid conflicts)</span>
                <span class="n">layer_data</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">layer_data</span> <span class="o">=</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">layer_data</span><span class="p">[</span><span class="s1">&#39;choropleth_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">index</span>
                <span class="n">layer_data</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">layer_data</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># Create color mapping</span>
                <span class="n">color_map</span> <span class="o">=</span> <span class="n">create_color_mapping</span><span class="p">(</span><span class="n">layer_data</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;color_scheme&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="p">)</span>
                
                <span class="c1"># Create GeoJson layer with custom styling</span>
                <span class="n">geojson_layer</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
                    <span class="n">layer_data</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">feature</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="n">color_map</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="n">color_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;choropleth_id&#39;</span><span class="p">],</span> <span class="s1">&#39;#gray&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;fillOpacity&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.2</span>
                    <span class="p">},</span>
                    <span class="n">highlight_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">feature</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#666&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;dashArray&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;fillOpacity&#39;</span><span class="p">:</span> <span class="mf">0.9</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                
                <span class="c1"># Add GeoJson layer to FeatureGroup</span>
                <span class="n">geojson_layer</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span>
                
                <span class="c1"># Add hover tooltip</span>
                <span class="n">folium</span><span class="o">.</span><span class="n">GeoJsonTooltip</span><span class="p">(</span>
                    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]],</span>
                    <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Admin Unit:&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">],</span>
                    <span class="n">localize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sticky</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        background-color: white;</span>
<span class="s2">                        border: 2px solid black;</span>
<span class="s2">                        border-radius: 3px;</span>
<span class="s2">                        box-shadow: 3px;</span>
<span class="s2">                        font-size: 12px;</span>
<span class="s2">                        padding: 10px;</span>
<span class="s2">                    &quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">geojson_layer</span><span class="p">)</span>
                
                <span class="c1"># Create custom legend for this layer</span>
                <span class="n">add_custom_legend</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">legend_top_position</span><span class="p">,</span> <span class="n">layers_created</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">legend_top_position</span> <span class="o">+=</span> <span class="n">compact_spacing</span>
                
                <span class="n">layers_created</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Added </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> color classes&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">layer_error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ❌ Failed to create </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">layer_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">layers_created</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No layers could be created&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>
        
        <span class="c1"># STEP 5: Add LayerControl LAST (critical for proper functionality)</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">(</span>
            <span class="n">position</span><span class="o">=</span><span class="s1">&#39;topright&#39;</span><span class="p">,</span>
            <span class="n">collapsed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">autoZIndex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
        <span class="c1"># STEP 6: Add JavaScript for legend visibility control</span>
        <span class="n">add_legend_visibility_control</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  🎉 SUCCESS: Created </span><span class="si">{</span><span class="n">layers_created</span><span class="si">}</span><span class="s2"> choropleth layers with DYNAMIC mappings!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error creating multi-layer choropleth: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># FIXED MULTI-LAYER CHOROPLETH IMPLEMENTATION</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_color_mapping</span><span class="p">(</span><span class="n">layer_data</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">color_scheme</span><span class="p">,</span> <span class="n">bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create color mapping for GeoJson styling&quot;&quot;&quot;</span>
    
    <span class="c1"># Define color schemes</span>
    <span class="n">color_schemes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Reds&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#fee5d9&#39;</span><span class="p">,</span> <span class="s1">&#39;#fcbba1&#39;</span><span class="p">,</span> <span class="s1">&#39;#fc9272&#39;</span><span class="p">,</span> <span class="s1">&#39;#fb6a4a&#39;</span><span class="p">,</span> <span class="s1">&#39;#de2d26&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Oranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#feedde&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdd0a2&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdae6b&#39;</span><span class="p">,</span> <span class="s1">&#39;#fd8d3c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d94701&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Blues&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#eff3ff&#39;</span><span class="p">,</span> <span class="s1">&#39;#c6dbef&#39;</span><span class="p">,</span> <span class="s1">&#39;#9ecae1&#39;</span><span class="p">,</span> <span class="s1">&#39;#6baed6&#39;</span><span class="p">,</span> <span class="s1">&#39;#2171b5&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="n">color_schemes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">color_scheme</span><span class="p">,</span> <span class="n">color_schemes</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">])</span>
    
    <span class="c1"># Create color mapping based on quantile bins</span>
    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">choropleth_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;choropleth_id&#39;</span><span class="p">]</span>
        
        <span class="c1"># Find which bin this value falls into</span>
        <span class="n">color_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">color_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">color_map</span><span class="p">[</span><span class="n">choropleth_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">color_map</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_custom_legend</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">top_position</span><span class="p">,</span> <span class="n">is_visible</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a compact custom legend positioned on the left side&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Define color schemes</span>
        <span class="n">color_schemes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Reds&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#fee5d9&#39;</span><span class="p">,</span> <span class="s1">&#39;#fcbba1&#39;</span><span class="p">,</span> <span class="s1">&#39;#fc9272&#39;</span><span class="p">,</span> <span class="s1">&#39;#fb6a4a&#39;</span><span class="p">,</span> <span class="s1">&#39;#de2d26&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Oranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#feedde&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdd0a2&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdae6b&#39;</span><span class="p">,</span> <span class="s1">&#39;#fd8d3c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d94701&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Blues&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#eff3ff&#39;</span><span class="p">,</span> <span class="s1">&#39;#c6dbef&#39;</span><span class="p">,</span> <span class="s1">&#39;#9ecae1&#39;</span><span class="p">,</span> <span class="s1">&#39;#6baed6&#39;</span><span class="p">,</span> <span class="s1">&#39;#2171b5&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="n">colors</span> <span class="o">=</span> <span class="n">color_schemes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;color_scheme&#39;</span><span class="p">],</span> <span class="n">color_schemes</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">])</span>
        
        <span class="c1"># Create legend entries</span>
        <span class="n">legend_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))):</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Format labels based on value ranges - MORE COMPACT</span>
            <span class="k">if</span> <span class="n">max_val</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0-</span><span class="si">{</span><span class="n">max_val</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_val</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_val</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">max_val</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0-</span><span class="si">{</span><span class="n">max_val</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">k&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_val</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">k-</span><span class="si">{</span><span class="n">max_val</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">k&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0-</span><span class="si">{</span><span class="n">max_val</span><span class="o">/</span><span class="mi">1000000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">M&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_val</span><span class="o">/</span><span class="mi">1000000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">M-</span><span class="si">{</span><span class="n">max_val</span><span class="o">/</span><span class="mi">1000000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">M&quot;</span>
            
            <span class="n">color_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">legend_entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">]))</span>
        
        <span class="c1"># Create unique legend ID</span>
        <span class="n">legend_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;legend-</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Create COMPACT legend HTML with reduced spacing</span>
        <span class="n">visibility</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span> <span class="k">if</span> <span class="n">is_visible</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">legend_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;div id=&quot;</span><span class="si">{</span><span class="n">legend_id</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">             class=&quot;custom-legend compact-legend&quot;</span>
<span class="s2">             style=&quot;position: fixed; </span>
<span class="s2">                   left: 15px; </span>
<span class="s2">                   top: </span><span class="si">{</span><span class="n">top_position</span><span class="si">}</span><span class="s2">px; </span>
<span class="s2">                   width: 100px;</span>
<span class="s2">                   background: rgba(255, 255, 255, 0.95); </span>
<span class="s2">                   border: 1px solid #666;</span>
<span class="s2">                   border-radius: 4px; </span>
<span class="s2">                   padding: 6px;</span>
<span class="s2">                   font-family: Arial, sans-serif;</span>
<span class="s2">                   font-size: 9px;</span>
<span class="s2">                   z-index: 1000; </span>
<span class="s2">                   box-shadow: 0 2px 6px rgba(0,0,0,0.1);</span>
<span class="s2">                   display: </span><span class="si">{</span><span class="n">visibility</span><span class="si">}</span><span class="s2">;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-weight: bold; </span>
<span class="s2">                       margin-bottom: 4px;</span>
<span class="s2">                       color: #333; </span>
<span class="s2">                       font-size: 10px;</span>
<span class="s2">                       border-bottom: 1px solid #ddd;</span>
<span class="s2">                       padding-bottom: 2px;&quot;&gt;</span>
<span class="s2">                </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Add COMPACT legend entries with minimal spacing</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">legend_entries</span><span class="p">:</span>
            <span class="n">legend_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;div style=&quot;display: flex; </span>
<span class="s2">                       align-items: center; </span>
<span class="s2">                       margin-bottom: 2px;</span>
<span class="s2">                       padding: 0;&quot;&gt;</span>
<span class="s2">                &lt;div style=&quot;width: 14px;</span>
<span class="s2">                           height: 10px;</span>
<span class="s2">                           background-color: </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">; </span>
<span class="s2">                           margin-right: 6px;</span>
<span class="s2">                           border: 1px solid #777;</span>
<span class="s2">                           border-radius: 1px;</span>
<span class="s2">                           flex-shrink: 0;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">                &lt;span style=&quot;font-size: 8px;</span>
<span class="s2">                            color: #444;</span>
<span class="s2">                            line-height: 1.0;&quot;&gt;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&lt;/span&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span>
        
        <span class="n">legend_html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span>
        
        <span class="c1"># Add legend to map</span>
        <span class="n">m</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">legend_html</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    🎨 Added compact legend for </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at position </span><span class="si">{</span><span class="n">top_position</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ⚠️ Failed to create legend for </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_legend_visibility_control</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add enhanced JavaScript to control legend visibility and dynamic positioning&quot;&quot;&quot;</span>
    
    <span class="n">legend_control_js</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;script&gt;</span>
<span class="s2">    // Enhanced legend control with dynamic positioning</span>
<span class="s2">    function repositionVisibleLegends() {</span>
<span class="s2">        // Get all custom legends</span>
<span class="s2">        var allLegends = document.querySelectorAll(&#39;.custom-legend&#39;);</span>
<span class="s2">        var visibleLegends = [];</span>
<span class="s2">        </span>
<span class="s2">        // Find visible legends and their layer names</span>
<span class="s2">        var layerLegendMap = {</span>
<span class="s2">            &#39;ADM1 - Deaths&#39;: &#39;legend-adm1deaths&#39;,</span>
<span class="s2">            &#39;ADM1 - Affected&#39;: &#39;legend-adm1affected&#39;, </span>
<span class="s2">            &#39;ADM1 - Disasters&#39;: &#39;legend-adm1disasters&#39;,</span>
<span class="s2">            &#39;ADM2 - Deaths&#39;: &#39;legend-adm2deaths&#39;,</span>
<span class="s2">            &#39;ADM2 - Affected&#39;: &#39;legend-adm2affected&#39;,</span>
<span class="s2">            &#39;ADM2 - Disasters&#39;: &#39;legend-adm2disasters&#39;</span>
<span class="s2">        };</span>
<span class="s2">        </span>
<span class="s2">        // Check layer control checkboxes to determine which legends should be visible</span>
<span class="s2">        var layerControl = document.querySelector(&#39;.leaflet-control-layers&#39;);</span>
<span class="s2">        if (layerControl) {</span>
<span class="s2">            var checkboxes = layerControl.querySelectorAll(&#39;input[type=&quot;checkbox&quot;]&#39;);</span>
<span class="s2">            </span>
<span class="s2">            checkboxes.forEach(function(checkbox) {</span>
<span class="s2">                var label = checkbox.nextSibling;</span>
<span class="s2">                if (label &amp;&amp; label.textContent) {</span>
<span class="s2">                    var layerName = label.textContent.trim();</span>
<span class="s2">                    var legendId = layerLegendMap[layerName];</span>
<span class="s2">                    </span>
<span class="s2">                    if (legendId) {</span>
<span class="s2">                        var legend = document.getElementById(legendId);</span>
<span class="s2">                        if (legend) {</span>
<span class="s2">                            if (checkbox.checked) {</span>
<span class="s2">                                legend.style.display = &#39;block&#39;;</span>
<span class="s2">                                visibleLegends.push(legend);</span>
<span class="s2">                            } else {</span>
<span class="s2">                                legend.style.display = &#39;none&#39;;</span>
<span class="s2">                            }</span>
<span class="s2">                        }</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            });</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Dynamically position visible legends starting from top</span>
<span class="s2">        var startTop = 80;  // Starting position</span>
<span class="s2">        var spacing = 100;  // Compact spacing between legends</span>
<span class="s2">        </span>
<span class="s2">        visibleLegends.forEach(function(legend, index) {</span>
<span class="s2">            var newTop = startTop + (index * spacing);</span>
<span class="s2">            legend.style.top = newTop + &#39;px&#39;;</span>
<span class="s2">            console.log(&#39;Repositioned legend to: &#39; + newTop + &#39;px&#39;);</span>
<span class="s2">        });</span>
<span class="s2">        </span>
<span class="s2">        console.log(&#39;Repositioned &#39; + visibleLegends.length + &#39; visible legends&#39;);</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    // Wait for map to fully load</span>
<span class="s2">    setTimeout(function() {</span>
<span class="s2">        var layerControl = document.querySelector(&#39;.leaflet-control-layers&#39;);</span>
<span class="s2">        if (layerControl) {</span>
<span class="s2">            var checkboxes = layerControl.querySelectorAll(&#39;input[type=&quot;checkbox&quot;]&#39;);</span>
<span class="s2">            </span>
<span class="s2">            // Add event listeners to checkboxes</span>
<span class="s2">            checkboxes.forEach(function(checkbox) {</span>
<span class="s2">                checkbox.addEventListener(&#39;change&#39;, function() {</span>
<span class="s2">                    // Small delay to ensure DOM is updated</span>
<span class="s2">                    setTimeout(repositionVisibleLegends, 50);</span>
<span class="s2">                });</span>
<span class="s2">            });</span>
<span class="s2">            </span>
<span class="s2">            // Initial positioning</span>
<span class="s2">            repositionVisibleLegends();</span>
<span class="s2">            </span>
<span class="s2">            console.log(&#39;Enhanced legend visibility and positioning controls initialized&#39;);</span>
<span class="s2">        }</span>
<span class="s2">    }, 1000);</span>
<span class="s2">    </span>
<span class="s2">    // Also reposition on window resize</span>
<span class="s2">    window.addEventListener(&#39;resize&#39;, function() {</span>
<span class="s2">        setTimeout(repositionVisibleLegends, 100);</span>
<span class="s2">    });</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    
    <span class="n">m</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">legend_control_js</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  🔧 Added enhanced JavaScript with dynamic legend positioning&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================================</span>
<span class="c1"># SUBNATIONAL ANALYSIS FUNCTIONS (UNCHANGED - WORKING)</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_subnational_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create enhanced subnational analysis for single country&quot;&quot;&quot;</span>
    
    <span class="c1"># Check if Admin Units column exists and has data</span>
    <span class="k">if</span> <span class="s1">&#39;Admin Units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Admin Units column found. Creating summary analysis...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_country_summary_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Parse Admin Units data</span>
    <span class="n">admin_data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">)):</span>
            <span class="n">admin_units</span> <span class="o">=</span> <span class="n">parse_admin_units</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">admin_units</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">admin_unit</span> <span class="ow">in</span> <span class="n">admin_units</span><span class="p">:</span>
                    <span class="c1"># Extract admin unit information</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_unit</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="c1"># Handle properly formatted admin data</span>
                        <span class="n">admin_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_name&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                                    <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm2_name&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                                    <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>
                        <span class="n">admin_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_code&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                                    <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm2_code&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                                    <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>
                        <span class="n">admin_level</span> <span class="o">=</span> <span class="s1">&#39;ADM1&#39;</span> <span class="k">if</span> <span class="s1">&#39;adm1_name&#39;</span> <span class="ow">in</span> <span class="n">admin_unit</span> <span class="k">else</span> <span class="s1">&#39;ADM2&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">admin_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">admin_unit</span><span class="p">)</span>
                        <span class="n">admin_code</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
                        <span class="n">admin_level</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
                    
                    <span class="n">admin_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;Admin Unit&#39;</span><span class="p">:</span> <span class="n">admin_name</span><span class="p">,</span>
                        <span class="s1">&#39;Admin Code&#39;</span><span class="p">:</span> <span class="n">admin_code</span><span class="p">,</span>
                        <span class="s1">&#39;Admin Level&#39;</span><span class="p">:</span> <span class="n">admin_level</span><span class="p">,</span>
                        <span class="s1">&#39;Hazard Type&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;Disaster Subtype&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Disaster Subtype&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;Start Date&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Start Date&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;Homeless&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;No Homeless&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;ISO&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid admin units data found. Creating summary analysis...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_country_summary_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Create DataFrame from parsed data</span>
    <span class="n">admin_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">admin_data</span><span class="p">)</span>
    
    <span class="c1"># Create comprehensive subnational analysis</span>
    <span class="k">return</span> <span class="n">create_subnational_visualization</span><span class="p">(</span><span class="n">admin_df</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_country_summary_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create summary analysis when no subnational data is available&quot;&quot;&quot;</span>
    
    <span class="c1"># Create summary by year and disaster type</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Start Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Disaster Type&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;Start Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    
    <span class="c1"># Create table</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="n">columnwidth</span><span class="o">=</span><span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
            <span class="n">header</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Hazard Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">40</span>
            <span class="p">),</span>
            <span class="n">cells</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">],</span> 
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;DisNo.&#39;</span><span class="p">],</span> 
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">30</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">country_name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;Selected Country&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Disaster Summary for </span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s1"> (No Subnational Data Available)&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_subnational_visualization</span><span class="p">(</span><span class="n">admin_df</span><span class="p">,</span> <span class="n">original_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create comprehensive subnational visualization with table and charts&quot;&quot;&quot;</span>
    
    <span class="c1"># Get country information</span>
    <span class="n">country_name</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;Selected Country&#39;</span>
    <span class="n">country_iso</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;XXX&#39;</span>
    
    <span class="c1"># Create subplots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;Subnational Disaster Data Table&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># Empty </span>
            <span class="s1">&#39;Disasters by Administrative Unit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Deaths by Administrative Unit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Affected Population by Administrative Unit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Economic Damage by Administrative Unit&#39;</span>
        <span class="p">],</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;colspan&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="kc">None</span><span class="p">],</span>
            <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}],</span>
            <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;pie&quot;</span><span class="p">}]</span>
        <span class="p">],</span>
        <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
        <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.20</span>
    <span class="p">)</span>
    
    <span class="c1"># 1. Create detailed table</span>
    <span class="n">table_data</span> <span class="o">=</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Affected&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="n">columnwidth</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
            <span class="n">header</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Admin Level&#39;</span><span class="p">,</span> <span class="s1">&#39;Hazard Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Homeless&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">,</span> <span class="s1">&#39;Start Date&#39;</span>
                <span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">35</span>
            <span class="p">),</span>
            <span class="n">cells</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">],</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Admin Level&#39;</span><span class="p">],</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Hazard Type&#39;</span><span class="p">],</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Affected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Homeless&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s1">&#39;Start Date&#39;</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">25</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># 2. Aggregate data for charts</span>
    <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>  <span class="c1"># Count of disasters</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">admin_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage&#39;</span><span class="p">,</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">]</span>
    <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Top 15</span>
    
    <span class="c1"># 3. Disasters by Admin Unit</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">],</span>
            <span class="n">x</span><span class="o">=</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">],</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span>
            <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">],</span>
            <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># 4. Deaths by Admin Unit</span>
    <span class="n">deaths_data</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="p">[</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Deaths&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">deaths_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">deaths_data</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">deaths_data</span><span class="p">[</span><span class="s1">&#39;Deaths&#39;</span><span class="p">],</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Deaths&#39;</span><span class="p">,</span>
                <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">deaths_data</span><span class="p">[</span><span class="s1">&#39;Deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
    
    <span class="c1"># 5. Affected by Admin Unit</span>
    <span class="n">affected_data</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="p">[</span><span class="n">admin_summary</span><span class="p">[</span><span class="s1">&#39;Affected&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">affected_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">affected_data</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">affected_data</span><span class="p">[</span><span class="s1">&#39;Affected&#39;</span><span class="p">],</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Affected&#39;</span><span class="p">,</span>
                <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">affected_data</span><span class="p">[</span><span class="s1">&#39;Affected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    
    <span class="c1"># 6. Hazard types pie chart</span>
    <span class="n">hazard_summary</span> <span class="o">=</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Hazard Type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">hazard_summary</span><span class="p">[</span><span class="s1">&#39;Hazard Type&#39;</span><span class="p">],</span>
            <span class="n">values</span><span class="o">=</span><span class="n">hazard_summary</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Hazard Types&#39;</span><span class="p">,</span>
            <span class="n">textinfo</span><span class="o">=</span><span class="s1">&#39;label+percent&#39;</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="c1"># Update layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Subnational Disaster Analysis - </span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">country_iso</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Update axes labels</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Number of Disasters&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Total Affected&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_admin_units_for_choropleth</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse admin units data for choropleth mapping - optimized version&quot;&quot;&quot;</span>
    
    <span class="n">admin_data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">)):</span>
                <span class="n">admin_units</span> <span class="o">=</span> <span class="n">parse_admin_units</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="n">admin_units</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">admin_unit</span> <span class="ow">in</span> <span class="n">admin_units</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">admin_unit</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="c1"># Handle ADM1 data</span>
                            <span class="k">if</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_code&#39;</span><span class="p">):</span>
                                <span class="n">admin_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s1">&#39;Admin Unit&#39;</span><span class="p">:</span> <span class="n">admin_unit</span><span class="p">[</span><span class="s1">&#39;adm1_name&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;Admin Code&#39;</span><span class="p">:</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm1_code&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;Admin Level&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM1&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Start Year&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;ISO&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ISO&#39;</span><span class="p">)</span>
                                <span class="p">})</span>
                            
                            <span class="c1"># Handle ADM2 data</span>
                            <span class="k">if</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm2_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm2_code&#39;</span><span class="p">):</span>
                                <span class="n">admin_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s1">&#39;Admin Unit&#39;</span><span class="p">:</span> <span class="n">admin_unit</span><span class="p">[</span><span class="s1">&#39;adm2_name&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;Admin Code&#39;</span><span class="p">:</span> <span class="n">admin_unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adm2_code&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;Admin Level&#39;</span><span class="p">:</span> <span class="s1">&#39;ADM2&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Damage (000 USD)&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Start Year&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;ISO&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ISO&#39;</span><span class="p">)</span>
                                <span class="p">})</span>
        
        <span class="k">if</span> <span class="n">admin_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📊 Parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">admin_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> admin unit records&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create summary by admin level</span>
            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">admin_data</span><span class="p">)</span>
            <span class="n">level_summary</span> <span class="o">=</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Admin Level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                <span class="s1">&#39;Admin Unit&#39;</span><span class="p">:</span> <span class="s1">&#39;nunique&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
            <span class="p">})</span>
            
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">level_summary</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">level_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> units, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Deaths&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> deaths, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Affected&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> affected&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">admin_data</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error parsing admin units: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_fallback_chart</span><span class="p">(</span><span class="n">admin_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create fallback bar chart when choropleth fails&quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">country_name</span> <span class="o">=</span> <span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Country&#39;</span> <span class="ow">in</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="c1"># Aggregate data by admin unit</span>
        <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">admin_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Disaster Count&#39;</span><span class="p">]</span>
        <span class="n">admin_summary</span> <span class="o">=</span> <span class="n">admin_summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Create horizontal bar chart</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">admin_summary</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span>
            <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s1"> - Administrative Units Disaster Impact (Choropleth Failed)&#39;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Disaster Count&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of Disasters&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">},</span>
            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Disaster Count&#39;</span>
        <span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
            <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">fig</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error creating fallback chart: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># ADDITIONAL VISUALIZATION FUNCTIONS (UNCHANGED - WORKING)</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_overview_stats</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create overview statistics HTML&quot;&quot;&quot;</span>
    
    <span class="n">total_disasters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">total_deaths</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_affected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_damage</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">countries_affected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">disaster_types</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    
    <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div style=&#39;background-color: #f0f0f0; padding: 20px; border-radius: 10px;&#39;&gt;</span>
<span class="s2">        &lt;h3&gt;Overview Statistics&lt;/h3&gt;</span>
<span class="s2">        &lt;div style=&#39;display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;&#39;&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #e74c3c;&#39;&gt;Total Disasters&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;</span><span class="si">{</span><span class="n">total_disasters</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #e67e22;&#39;&gt;Total Deaths&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;</span><span class="si">{</span><span class="n">total_deaths</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #f39c12;&#39;&gt;Total Affected&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;</span><span class="si">{</span><span class="n">total_affected</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #27ae60;&#39;&gt;Economic Damage&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;$</span><span class="si">{</span><span class="n">total_damage</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">k&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #3498db;&#39;&gt;Countries Affected&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;</span><span class="si">{</span><span class="n">countries_affected</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div style=&#39;background: white; padding: 15px; border-radius: 5px;&#39;&gt;</span>
<span class="s2">                &lt;h4 style=&#39;color: #9b59b6;&#39;&gt;Disaster Types&lt;/h4&gt;</span>
<span class="s2">                &lt;p style=&#39;font-size: 24px; font-weight: bold;&#39;&gt;</span><span class="si">{</span><span class="n">disaster_types</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_disaster_type_chart</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create disaster type analysis charts&quot;&quot;&quot;</span>
    
    <span class="c1"># Aggregate data by disaster type</span>
    <span class="n">disaster_stats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">disaster_stats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage&#39;</span><span class="p">]</span>
    <span class="n">disaster_stats</span> <span class="o">=</span> <span class="n">disaster_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Create subplots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Number of Disasters&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Economic Damage (000 USD)&#39;</span><span class="p">),</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}],</span>
               <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}]]</span>
    <span class="p">)</span>
    
    <span class="c1"># Add traces</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">],</span> 
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Deaths&#39;</span><span class="p">],</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Affected&#39;</span><span class="p">],</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">disaster_stats</span><span class="p">[</span><span class="s1">&#39;Damage&#39;</span><span class="p">],</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Damage&#39;</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="c1"># Update layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Disaster Impact by Type&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">tickangle</span><span class="o">=-</span><span class="mi">45</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_temporal_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create temporal trend analysis&quot;&quot;&quot;</span>
    
    <span class="c1"># Aggregate by year</span>
    <span class="n">yearly_stats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Start Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Disaster Category&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Create figure with secondary y-axis</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Disaster Frequency Over Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Deaths and Affected Population Over Time&#39;</span><span class="p">),</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;secondary_y&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}],</span>
               <span class="p">[{</span><span class="s2">&quot;secondary_y&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]]</span>
    <span class="p">)</span>
    
    <span class="c1"># Disaster frequency</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;DisNo.&#39;</span><span class="p">],</span>
                  <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Number of Disasters&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Deaths and affected</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">],</span>
                  <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Deaths&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">],</span>
                  <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Affected&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    
    <span class="c1"># Update layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Deaths&quot;</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Affected&quot;</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Temporal Analysis of Disasters&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_loss_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create loss analysis by hazard category&quot;&quot;&quot;</span>
    
    <span class="c1"># Aggregate by disaster category</span>
    <span class="n">category_stats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Create pie charts</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Distribution of Disasters&#39;</span><span class="p">,</span> <span class="s1">&#39;Distribution of Deaths&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Distribution of Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Distribution of Economic Damage&#39;</span><span class="p">),</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">}],</span>
               <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">}]]</span>
    <span class="p">)</span>
    
    <span class="c1"># Add pie charts</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">],</span> 
               <span class="n">values</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;DisNo.&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Deaths&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Affected&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Disaster Category&#39;</span><span class="p">],</span>
               <span class="n">values</span><span class="o">=</span><span class="n">category_stats</span><span class="p">[</span><span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Damage&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Loss Distribution by Disaster Category&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_geographic_distribution</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create geographic distribution map&quot;&quot;&quot;</span>
    
    <span class="c1"># Aggregate by country</span>
    <span class="n">country_stats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;Country&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Create choropleth map</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">choropleth</span><span class="p">(</span>
        <span class="n">country_stats</span><span class="p">,</span>
        <span class="n">locations</span><span class="o">=</span><span class="s1">&#39;ISO&#39;</span><span class="p">,</span>
        <span class="n">locationmode</span><span class="o">=</span><span class="s1">&#39;ISO-3&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;DisNo.&#39;</span><span class="p">,</span>
        <span class="n">hover_name</span><span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span>
        <span class="n">hover_data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;:,&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Total Deaths&#39;</span><span class="p">:</span> <span class="s1">&#39;:,.0f&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Total Affected&#39;</span><span class="p">:</span> <span class="s1">&#39;:,.0f&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">:</span> <span class="s1">&#39;:,.0f&#39;</span>
        <span class="p">},</span>
        <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s1">&#39;YlOrRd&#39;</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DisNo.&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of Disasters&#39;</span><span class="p">},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Geographic Distribution of Disasters&#39;</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">geo</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">showframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">showcoastlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">projection_type</span><span class="o">=</span><span class="s1">&#39;natural earth&#39;</span>
        <span class="p">),</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">600</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># UPDATED VISUALIZATION FUNCTIONS</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_visualizations</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">dashboard</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create all visualizations for the dashboard with FIXED subnational analysis&quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data available for selected filters&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Create tabs for different visualizations</span>
    <span class="n">tab_contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tab_titles</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Tab 1: Overview Statistics</span>
    <span class="n">overview_html</span> <span class="o">=</span> <span class="n">create_overview_stats</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
    <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">overview_html</span><span class="p">))</span>
    <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Overview&#39;</span><span class="p">)</span>
    
    <span class="c1"># Tab 2: Disaster Type Analysis</span>
    <span class="n">disaster_fig</span> <span class="o">=</span> <span class="n">create_disaster_type_chart</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
    <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">tab_contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">disaster_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Disaster Types&#39;</span><span class="p">)</span>
    
    <span class="c1"># Tab 3: Temporal Analysis</span>
    <span class="n">temporal_fig</span> <span class="o">=</span> <span class="n">create_temporal_analysis</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
    <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">tab_contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">temporal_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Temporal Trends&#39;</span><span class="p">)</span>
    
    <span class="c1"># Tab 4: Loss Analysis</span>
    <span class="n">loss_fig</span> <span class="o">=</span> <span class="n">create_loss_analysis</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
    <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">tab_contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">loss_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Loss Analysis&#39;</span><span class="p">)</span>
    
    <span class="c1"># Tab 5: Geographic Distribution (if multiple countries)</span>
    <span class="k">if</span> <span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">geo_fig</span> <span class="o">=</span> <span class="n">create_geographic_distribution</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">tab_contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">geo_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Geographic Distribution&#39;</span><span class="p">)</span>
    
    <span class="c1"># Tab 6: FIXED Subnational Analysis (if single country selected)</span>
    <span class="k">if</span> <span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Create the main subnational analysis</span>
        <span class="n">subnational_fig</span> <span class="o">=</span> <span class="n">create_subnational_analysis</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subnational_fig</span><span class="p">:</span>
            <span class="n">tab_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">())</span>
            <span class="k">with</span> <span class="n">tab_contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">subnational_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                
                <span class="c1"># Add FIXED multi-layer choropleth if admin data exists and GPKG provided</span>
                <span class="k">if</span> <span class="s1">&#39;Admin Units&#39;</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">gpkg_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">):</span>
                    <span class="n">admin_data_count</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Records with Admin Units: </span><span class="si">{</span><span class="n">admin_data_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">admin_data_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🗺️ CREATING FIXED MULTI-LAYER CHOROPLETH MAP&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                        
                        <span class="c1"># Parse admin data for choropleth</span>
                        <span class="n">admin_data</span> <span class="o">=</span> <span class="n">parse_admin_units_for_choropleth</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">admin_data</span><span class="p">:</span>
                            <span class="n">admin_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">admin_data</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Parsed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">admin_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> admin records&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏛️ Admin levels: </span><span class="si">{</span><span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Admin Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📍 Unique admin units: </span><span class="si">{</span><span class="n">admin_df</span><span class="p">[</span><span class="s1">&#39;Admin Unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                            <span class="c1"># Create the FIXED multi-layer choropleth</span>
                            <span class="n">choropleth_map</span> <span class="o">=</span> <span class="n">create_working_multi_layer_choropleth</span><span class="p">(</span>
                                <span class="n">admin_df</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">gpkg_file_path</span>
                            <span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">choropleth_map</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎉 SUCCESS: Fixed multi-layer choropleth created!&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Features:&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ 6 independent layers (ADM1/ADM2 × Deaths/Affected/Count)&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ Proper color scaling (Reds/Oranges/Blues)&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ Dynamic legends (250px width, left-side)&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ Layer visibility controls&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ Hover tooltips and info&quot;</span><span class="p">)</span>
                                <span class="n">display</span><span class="p">(</span><span class="n">choropleth_map</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Failed to create choropleth map - check data and boundaries&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No valid admin data found after parsing&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ No admin units data available for choropleth mapping&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">gpkg_file_path</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ No GPKG file path provided - choropleth mapping disabled&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gpkg_file_path</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ GPKG file not found: </span><span class="si">{</span><span class="n">gpkg_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Admin Units column not found in data&quot;</span><span class="p">)</span>
            
            <span class="n">tab_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Subnational Analysis&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create and display tabs</span>
    <span class="n">tabs</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Tab</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">tab_contents</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tab_titles</span><span class="p">):</span>
        <span class="n">tabs</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">tabs</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_country_selector</span><span class="p">(</span><span class="n">dashboard</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create interactive country selector widget with FIXED choropleth&quot;&quot;&quot;</span>
    
    <span class="c1"># Get unique countries with their ISO codes</span>
    <span class="n">countries_df</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;ISO&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span>
    <span class="n">country_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">countries_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
    
    <span class="c1"># Create dropdown widget</span>
    <span class="n">country_dropdown</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;All Countries&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">country_list</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s1">&#39;All Countries&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select Country:&#39;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">},</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;400px&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Create date range slider</span>
    <span class="n">year_range</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntRangeSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2024</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
        <span class="nb">max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Year Range:&#39;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">},</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;600px&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Output area for visualizations</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_dashboard</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update dashboard based on selection&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Filter data based on selection</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># Filter by year range</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">year_range</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> 
                <span class="p">(</span><span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">year_range</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]</span>
            
            <span class="c1"># Filter by country if not &quot;All Countries&quot;</span>
            <span class="k">if</span> <span class="n">country_dropdown</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;All Countries&#39;</span><span class="p">:</span>
                <span class="n">country_iso</span> <span class="o">=</span> <span class="n">country_dropdown</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_iso</span><span class="p">]</span>
                <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;h2&gt;Disaster Analysis for </span><span class="si">{</span><span class="n">country_dropdown</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&lt;/h2&gt;&quot;</span><span class="p">))</span>
                
                <span class="c1"># Show choropleth availability info for single country</span>
                <span class="k">if</span> <span class="n">gpkg_file_path</span> <span class="ow">and</span> <span class="s1">&#39;Admin Units&#39;</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">admin_count</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">admin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">admin_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p style=&#39;color: green;&#39;&gt;&lt;strong&gt;✅ Enhanced choropleth mapping available!&lt;/strong&gt;&lt;br&gt;&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;📊 </span><span class="si">{</span><span class="n">admin_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> records have subnational data (</span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% coverage)&lt;br&gt;&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;🗺️ Look for the &#39;Subnational Analysis&#39; tab with interactive maps&lt;/p&gt;&quot;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p style=&#39;color: orange;&#39;&gt;⚠️ No subnational data available for choropleth mapping&lt;/p&gt;&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h2&gt;Global Disaster Analysis&lt;/h2&gt;&quot;</span><span class="p">))</span>
            
            <span class="c1"># Generate visualizations with FIXED choropleth</span>
            <span class="n">create_visualizations</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">dashboard</span><span class="p">,</span> <span class="n">gpkg_file_path</span><span class="p">)</span>
    
    <span class="c1"># Link widgets to update function</span>
    <span class="n">country_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_dashboard</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="n">year_range</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_dashboard</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    
    <span class="c1"># Display instructions</span>
    <span class="n">instructions_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div style=&#39;background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007acc;&#39;&gt;</span>
<span class="s2">        &lt;h3 style=&#39;margin-top: 0; color: #007acc;&#39;&gt;🗺️ Instructions&lt;/h3&gt;</span>
<span class="s2">        &lt;p&gt;&lt;strong&gt;For enhanced mapping:&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">        &lt;ul&gt;</span>
<span class="s2">            &lt;li&gt;Select a single country with subnational data&lt;/li&gt;</span>
<span class="s2">            &lt;li&gt;Navigate to the &#39;Subnational Analysis&#39; tab&lt;/li&gt;</span>
<span class="s2">            &lt;li&gt;Use layer checkboxes to toggle between metrics independently&lt;/li&gt;</span>
<span class="s2">            &lt;li&gt;Legends automatically show/hide based on layer visibility&lt;/li&gt;</span>
<span class="s2">            &lt;li&gt;Hover over administrative units for detailed information&lt;/li&gt;</span>
<span class="s2">        &lt;/ul&gt;</span>
<span class="s2">        &lt;p&gt;&lt;strong&gt;Available layers:&lt;/strong&gt; ADM1/ADM2 levels × Deaths (Red) / Affected (Orange) / Disaster Count (Blue)&lt;/p&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Display widgets</span>
    <span class="n">display</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h1&gt;EMDAT Disaster Data Dashboard&lt;/h1&gt;&quot;</span><span class="p">),</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">instructions_html</span><span class="p">),</span>
        <span class="n">country_dropdown</span><span class="p">,</span>
        <span class="n">year_range</span><span class="p">,</span>
        <span class="n">output</span>
    <span class="p">]))</span>
    
    <span class="c1"># Initial display</span>
    <span class="n">update_dashboard</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">quick_subnational_check</span><span class="p">(</span><span class="n">dashboard</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quick check of subnational data availability across all countries&quot;&quot;&quot;</span>
    
    <span class="n">countries_with_admin</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">country_iso</span> <span class="ow">in</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">country_df</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_iso</span><span class="p">]</span>
        <span class="n">country_name</span> <span class="o">=</span> <span class="n">country_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="s1">&#39;Admin Units&#39;</span> <span class="ow">in</span> <span class="n">country_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">admin_count</span> <span class="o">=</span> <span class="n">country_df</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">country_df</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">admin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">admin_count</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">countries_with_admin</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="n">country_name</span><span class="p">,</span>
                    <span class="s1">&#39;ISO&#39;</span><span class="p">:</span> <span class="n">country_iso</span><span class="p">,</span>
                    <span class="s1">&#39;Total_Disasters&#39;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
                    <span class="s1">&#39;With_Admin_Data&#39;</span><span class="p">:</span> <span class="n">admin_count</span><span class="p">,</span>
                    <span class="s1">&#39;Coverage_Percent&#39;</span><span class="p">:</span> <span class="n">coverage</span>
                <span class="p">})</span>
    
    <span class="k">if</span> <span class="n">countries_with_admin</span><span class="p">:</span>
        <span class="n">admin_summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">countries_with_admin</span><span class="p">)</span>
        <span class="n">admin_summary_df</span> <span class="o">=</span> <span class="n">admin_summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Coverage_Percent&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Countries with Subnational Data:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">admin_summary_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Coverage_Percent&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% coverage &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;With_Admin_Data&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Total_Disasters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> disasters)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">admin_summary_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No countries found with subnational admin data.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_complete_dashboard</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the complete EMDAT dashboard with FIXED choropleth&quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EMDAT DISASTER DATA DASHBOARD - FIXED CHOROPLETH&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing dashboard components...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if data is loaded</span>
    <span class="k">if</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No data loaded. Please check your Excel file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Check GPKG file availability</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">GPKG_FILE_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ GPKG boundaries available: </span><span class="si">{</span><span class="n">GPKG_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🗺️ Enhanced choropleth mapping enabled!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ GPKG file not available - choropleth mapping disabled&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 Expected path: </span><span class="si">{</span><span class="n">GPKG_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Display data quality report</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Data Quality Report:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Total records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Missing values in key columns:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Affected&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Damages (</span><span class="se">\&#39;</span><span class="s1">000 US$)&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">missing</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    • </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">missing</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check subnational data availability</span>
    <span class="k">if</span> <span class="s1">&#39;Admin Units&#39;</span> <span class="ow">in</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">admin_count</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">admin_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">admin_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🏛️ Subnational Data Availability:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Records with admin units: </span><span class="si">{</span><span class="n">admin_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">admin_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">admin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Show top countries with subnational data</span>
            <span class="n">countries_with_admin</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">country_iso</span> <span class="ow">in</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Check top 10 countries</span>
                <span class="n">country_df</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country_iso</span><span class="p">]</span>
                <span class="n">country_admin_count</span> <span class="o">=</span> <span class="n">country_df</span><span class="p">[</span><span class="s1">&#39;Admin Units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">country_admin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">country_admin_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">country_df</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">countries_with_admin</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="n">country_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;ISO&#39;</span><span class="p">:</span> <span class="n">country_iso</span><span class="p">,</span>
                        <span class="s1">&#39;Coverage&#39;</span><span class="p">:</span> <span class="n">coverage</span><span class="p">,</span>
                        <span class="s1">&#39;Records&#39;</span><span class="p">:</span> <span class="n">country_admin_count</span>
                    <span class="p">})</span>
            
            <span class="k">if</span> <span class="n">countries_with_admin</span><span class="p">:</span>
                <span class="n">countries_with_admin</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Coverage&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Top countries for choropleth mapping:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries_with_admin</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    • </span><span class="si">{</span><span class="n">country</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">country</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">country</span><span class="p">[</span><span class="s1">&#39;Coverage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% coverage&quot;</span><span class="p">)</span>
    
    <span class="c1"># Display summary statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🌍 Dataset Summary:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Countries: </span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ISO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Time period: </span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Start Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Disaster types: </span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Disaster Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Total deaths: </span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Deaths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Total affected: </span><span class="si">{</span><span class="n">dashboard</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total Affected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🚀 Dashboard Features:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Interactive country and time filtering&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Multiple visualization tabs&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Statistical analysis and charts&quot;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">GPKG_FILE_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✅ Multi-layer choropleth maps with:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • 6 independent layers (ADM1/ADM2 × 3 metrics)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • Quantile-based color scaling&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • 250px left-side legends with visibility control&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • Layer checkboxes for independent toggling&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • Hover tooltips and administrative unit info&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📊 Bar chart fallbacks when choropleth unavailable&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Dashboard ready! Use the interactive controls to explore the data.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># MAIN EXECUTION</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># Check file availability</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 INITIALIZING EMDAT DASHBOARD WITH FIXED CHOROPLETH&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📁 Checking file availability...&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">EXCEL_FILE_PATH</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ EMDAT Excel file found: </span><span class="si">{</span><span class="n">EXCEL_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ EMDAT Excel file not found: </span><span class="si">{</span><span class="n">EXCEL_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Please update EXCEL_FILE_PATH in the configuration above&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">GPKG_FILE_PATH</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ GPKG file found: </span><span class="si">{</span><span class="n">GPKG_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ GPKG file not found: </span><span class="si">{</span><span class="n">GPKG_FILE_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Please update GPKG_FILE_PATH in the configuration above&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Choropleth maps will not be available without GPKG boundaries&quot;</span><span class="p">)</span>

<span class="c1"># Initialize the dashboard</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🏗️ Initializing EMDAT Dashboard...&quot;</span><span class="p">)</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">EMDATDashboard</span><span class="p">(</span><span class="n">EXCEL_FILE_PATH</span><span class="p">)</span>

<span class="k">if</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Check subnational data availability</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checking subnational data availability...&quot;</span><span class="p">)</span>
    <span class="n">subnational_summary</span> <span class="o">=</span> <span class="n">quick_subnational_check</span><span class="p">(</span><span class="n">dashboard</span><span class="p">)</span>
    
    <span class="c1"># Run the dashboard</span>
    <span class="n">run_complete_dashboard</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🎉 STARTING INTERACTIVE DASHBOARD&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎯 Select a country with subnational data to see enhanced choropleth maps!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 Use the controls below to filter and explore the data.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💡 Pro tip: Countries with higher subnational coverage will have better choropleth maps.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Start the interactive dashboard with FIXED implementation</span>
    <span class="n">create_country_selector</span><span class="p">(</span><span class="n">dashboard</span><span class="p">,</span> <span class="n">GPKG_FILE_PATH</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">GPKG_FILE_PATH</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot start dashboard - data not loaded&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please check your EXCEL_FILE_PATH configuration and re-run the script.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ GeoPandas available - choropleth maps enabled
🚀 INITIALIZING EMDAT DASHBOARD WITH FIXED CHOROPLETH
============================================================

📁 Checking file availability...
✅ EMDAT Excel file found: emdat_2025.xlsx
✅ GPKG file found: X:/Work/Geodata/ADM/ADM_GAUL.gpkg

🏗️ Initializing EMDAT Dashboard...
Loading data from emdat_2025.xlsx...
Data loaded successfully!
Shape: (15739, 46)
Years covered: 1900 - 2025
Countries: 228
Disaster types: 10
Data preparation completed!

Checking subnational data availability...
Countries with Subnational Data:
==================================================
Saint Helena (SHN): 100.0% coverage (1/1 disasters)
Northern Mariana Islands (MNP): 100.0% coverage (5/5 disasters)
Timor-Leste (TLS): 100.0% coverage (10/10 disasters)
Cayman Islands (CYM): 100.0% coverage (7/7 disasters)
Qatar (QAT): 100.0% coverage (1/1 disasters)
South Sudan (SSD): 95.0% coverage (19/20 disasters)
North Macedonia (MKD): 91.3% coverage (21/23 disasters)
Burundi (BDI): 90.2% coverage (46/51 disasters)
State of Palestine (PSE): 87.5% coverage (7/8 disasters)
Angola (AGO): 85.7% coverage (48/56 disasters)
Saudi Arabia (SAU): 85.2% coverage (23/27 disasters)
Bosnia and Herzegovina (BIH): 83.9% coverage (26/31 disasters)
Croatia (HRV): 82.9% coverage (29/35 disasters)
Serbia (SRB): 81.8% coverage (27/33 disasters)
Namibia (NAM): 81.5% coverage (22/27 disasters)
Rwanda (RWA): 80.0% coverage (36/45 disasters)
Seychelles (SYC): 80.0% coverage (4/5 disasters)
Suriname (SUR): 80.0% coverage (4/5 disasters)
Serbia Montenegro (SCG): 78.6% coverage (11/14 disasters)
Tajikistan (TJK): 78.3% coverage (54/69 disasters)
============================================================
EMDAT DISASTER DATA DASHBOARD - FIXED CHOROPLETH
============================================================

Initializing dashboard components...
✅ GPKG boundaries available: X:/Work/Geodata/ADM/ADM_GAUL.gpkg
🗺️ Enhanced choropleth mapping enabled!

📊 Data Quality Report:
  - Total records: 15,739
  - Missing values in key columns:
    • Total Deaths: 0 (0.0%)
    • Total Affected: 0 (0.0%)
    • Total Damages (&#39;000 US$): 0 (0.0%)

🏛️ Subnational Data Availability:
  - Records with admin units: 8,428 (53.5%)
  - Top countries for choropleth mapping:
    • Guatemala (GTM): 63.9% coverage
    • Myanmar (MMR): 55.7% coverage
    • India (IND): 49.9% coverage
    • United States of America (USA): 48.4% coverage
    • Saint Vincent and the Grenadines (VCT): 44.0% coverage

🌍 Dataset Summary:
  - Countries: 228
  - Time period: 1900-2025
  - Disaster types: 10
  - Total deaths: 23,058,268
  - Total affected: 8,810,390,058

🚀 Dashboard Features:
  ✅ Interactive country and time filtering
  ✅ Multiple visualization tabs
  ✅ Statistical analysis and charts
  ✅ FIXED multi-layer choropleth maps with:
      • 6 independent layers (ADM1/ADM2 × 3 metrics)
      • Proper quantile-based color scaling
      • 250px left-side legends with visibility control
      • Layer checkboxes for independent toggling
      • Hover tooltips and administrative unit info

✅ Dashboard ready! Use the interactive controls to explore the data.
------------------------------------------------------------

🎉 STARTING INTERACTIVE DASHBOARD
==================================================
🎯 Select a country with subnational data to see enhanced choropleth maps!
📊 Use the controls below to filter and explore the data.

💡 Pro tip: Countries with higher subnational coverage will have better choropleth maps.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c9f0bbd27579448a8468bb9b6cd49d43", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tools/utility/emdat"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

            </article>
            

            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="../mapping.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Mapping &amp; Geocoding</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="../../../docs/philosophy_of_mapping.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">The Philosophy of Mapping</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-dashboard-with-quantile-based-choropleth-maps">
   Interactive Dashboard with Quantile-Based Choropleth Maps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#features">
     Features:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#required-input">
     Required input:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#usage-tips">
     Usage Tips:
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By M. Amadio (GFDRR)
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    <p class="last-updated">
Last updated on Oct 27, 2025.<br>
</p>
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>Cite as: <i>"Amadio M. (GFDRR) - CCDR tools data and methodology, 2024. Available at https://gfdrr.github.io/CCDR-tools"</i><br>
    <b>All content (unless otherwise specified) is subject to the <a href="https://raw.githubusercontent.com/worldbank/template/main/LICENSE">World Bank Master Community License Agreement.</a></b>
</div>

</div>
  </div>
  
</div>
          </div>
        </footer>
        

      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  </body>
</html>