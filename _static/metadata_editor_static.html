<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDLS Metadata Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-checkbox {
            margin-bottom: 0.5rem;
        }
        .tab-content {
            min-height: 400px;
        }
        .nav-tabs .nav-link {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .nav-tabs .nav-link.hazard-tab {
            background-color: #e6f3ff;
            border-color: #007fc3;
            color: #007fc3;
        }
        .nav-tabs .nav-link.hazard-tab.active {
            background-color: #007fc3;
            border-color: #007fc3;
            color: white;
        }
        .nav-tabs .nav-link.exposure-tab {
            background-color: #e6fffe;
            border-color: #00cbab;
            color: #00cbab;
        }
        .nav-tabs .nav-link.exposure-tab.active {
            background-color: #00cbab;
            border-color: #00cbab;
            color: white;
        }
        .nav-tabs .nav-link.vulnerability-tab {
            background-color: #fff9e6;
            border-color: #ffc757;
            color: #b8941f;
        }
        .nav-tabs .nav-link.vulnerability-tab.active {
            background-color: #ffc757;
            border-color: #ffc757;
            color: white;
        }
        .nav-tabs .nav-link.loss-tab {
            background-color: #ffe6ec;
            border-color: #f3436a;
            color: #f3436a;
        }
        .nav-tabs .nav-link.loss-tab.active {
            background-color: #f3436a;
            border-color: #f3436a;
            color: white;
        }
        .nav-tabs .nav-link.general-tab {
            background-color: #f8f9fa;
            border-color: #6c757d;
            color: #6c757d;
        }
        .nav-tabs .nav-link.general-tab.active {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .form-field { 
            margin-bottom: 1rem; 
            position: relative;
        }
        .validation-indicator {
            position: absolute;
            right: 10px;
            top: 35px;
            z-index: 10;
            font-size: 1.2rem;
        }
        .validation-indicator.valid {
            color: #28a745;
        }
        .validation-indicator.invalid {
            color: #dc3545;
        }
        .field-with-validation {
            padding-right: 35px;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .autocomplete-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        .autocomplete-suggestion:hover {
            background-color: #f8f9fa;
        }
        .combobox-wrapper {
            position: relative;
        }
        .combobox-wrapper .dropdown-toggle {
            border-left: none;
            padding: 0.375rem 0.5rem;
        }
        .combobox-wrapper .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .combobox-wrapper .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .array-field { 
            border: 1px solid #dee2e6; 
            padding: 1rem; 
            border-radius: 0.375rem; 
            margin-bottom: 1rem; 
            background-color: #fafafa;
        }
        .array-item { 
            background-color: #f8f9fa; 
            padding: 0.5rem; 
            margin: 0.5rem 0; 
            border-radius: 0.25rem; 
            border: 1px solid #e9ecef;
        }
        .object-field { 
            border: 1px solid #e9ecef; 
            padding: 1rem; 
            border-radius: 0.375rem; 
            margin-bottom: 1rem; 
            background-color: #fbfcfd; 
        }
        .required { 
            border-left: 3px solid #dc3545; 
            padding-left: 0.5rem;
        }
        .schema-status {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .file-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .file-drop-zone:hover { border-color: #007bff; }
        .file-drop-zone.dragover { border-color: #28a745; background-color: #f8f9fa; }
        .validation-progress {
            margin-bottom: 1rem;
        }
        .object-summary-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        .object-summary-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .object-summary-details {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .object-modal {
            max-width: 800px;
        }
        .modal-form-field {
            margin-bottom: 1rem;
        }
        .field-hint {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .bbox-field {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .bbox-field input {
            font-size: 0.9rem;
        }
        .bbox-preview {
            background-color: #f8f9fa !important;
            font-family: 'Courier New', monospace !important;
            color: #495057;
            border: 1px solid #ced4da;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="py-4 border-bottom">
            <div class="d-flex align-items-center gap-3">
                <img src="https://gfdrr.github.io/CCDR-tools/_static/logo_flat.png" alt="GFDRR Logo" style="height: 100px;">
                <div>
                    <h1 class="h3 mb-1">RDLS Metadata Editor</h1>
                    <p class="text-muted mb-0">
                        Generate RDLS-compliant metadata with real-time validation, auto-completion, and smart combobox fields
                        <span class="badge bg-success ms-2">Enhanced v2.1</span>
                    </p>
                </div>
            </div>
        </header>

        <div class="row mt-4">
            <!-- Configuration Panel -->
            <div class="col-md-3">
                <!-- Schema Version Selection -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>📋 Schema Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Schema Version:</label>
                            <select id="schemaVersionSelect" class="form-select">
                                <option value="">Loading schema versions...</option>
                            </select>
                            <div id="schemaStatus" class="schema-status text-muted"></div>
                        </div>

                        <!-- Section Selectors -->
                        <div class="mb-3">
                            <label class="form-label">Dataset Sections:</label>
                            <div class="section-checkbox">
                                <input type="checkbox" id="generalCheck" class="form-check-input" checked disabled>
                                <label for="generalCheck" class="form-check-label ms-2">
                                    <span class="badge bg-secondary">General Metadata</span> (Required)
                                </label>
                            </div>
                            <div class="section-checkbox">
                                <input type="checkbox" id="hazardCheck" class="form-check-input">
                                <label for="hazardCheck" class="form-check-label ms-2">
                                    <span class="badge" style="background-color: #007fc3;">Hazard Metadata</span>
                                </label>
                            </div>
                            <div class="section-checkbox">
                                <input type="checkbox" id="exposureCheck" class="form-check-input">
                                <label for="exposureCheck" class="form-check-label ms-2">
                                    <span class="badge" style="background-color: #00cbab;">Exposure Metadata</span>
                                </label>
                            </div>
                            <div class="section-checkbox">
                                <input type="checkbox" id="vulnerabilityCheck" class="form-check-input">
                                <label for="vulnerabilityCheck" class="form-check-label ms-2">
                                    <span class="badge" style="background-color: #ffc757">Vulnerability Metadata</span>
                                </label>
                            </div>
                            <div class="section-checkbox">
                                <input type="checkbox" id="lossCheck" class="form-check-input">
                                <label for="lossCheck" class="form-check-label ms-2">
                                    <span class="badge" style="background-color: #f3436a;">Loss Metadata</span>
                                </label>
                            </div>
                        </div>

                        <!-- Custom Schema Upload -->
                        <div class="mb-3">
                            <label class="form-label">Custom Schema:</label>
                            <div class="file-drop-zone" id="schemaDropZone">
                                <small>📁 Drop RDLS schema file here<br>or click to browse<br><em>Try uploading the RDLS v2.1 schema for combobox features!</em></small>
                                <input type="file" id="schemaFile" accept=".json" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Panel -->
                <div class="card">
                    <div class="card-header">
                        <h6>💾 Data Management</h6>
                    </div>
                    <div class="card-body">
                        <button id="loadData" class="btn btn-outline-secondary btn-sm w-100 mb-2">Load Existing Metadata</button>
                        <button id="saveProgress" class="btn btn-outline-info btn-sm w-100 mb-2">Save Progress</button>
                        <button id="exportJson" class="btn btn-success btn-sm w-100 mb-2">Export JSON</button>
                        <button id="exportXml" class="btn btn-success btn-sm w-100 mb-2">Export XML</button>
                        <button id="validateForm" class="btn btn-outline-primary btn-sm w-100 mt-2">🔍 Validate Metadata</button>
                    </div>
                </div>
            </div>

            <!-- Form Generation Area -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>📋 RDLS Metadata Form</h5>
                        <span id="formStatus" class="badge bg-secondary">No schema loaded</span>
                    </div>
                    <div class="card-body">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs" id="metadataTabs" role="tablist" style="display: none;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active general-tab" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                    General
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="metadataTabContent">
                            <div class="tab-pane fade show active" id="general" role="tabpanel">
                                <div id="metadataForm">
                                    <div class="text-center text-muted py-5">
                                        <div style="font-size: 4rem;">🌍</div>
                                        <p>Schema will load automatically and configure sections as needed</p>
                                        <small class="text-muted">Enhanced with real-time validation, combobox fields, and RDLS compliance checking</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Preview -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h6>👀 Live Preview & Validation</h6>
                    </div>
                    <div class="card-body">
                        <!-- Validation Progress -->
                        <div class="validation-progress">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted"><strong>Validation Status</strong></small>
                                <span id="overallValidation" class="badge bg-secondary">Not validated</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div id="validationProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">
                                <span id="validFieldCount">0</span>/<span id="totalFieldCount">0</span> fields valid
                            </small>
                        </div>
                        
                        <pre id="outputPreview" class="bg-light p-3 rounded" style="font-size: 0.8rem; max-height: 300px; overflow-y: auto;">
{
  "message": "Enhanced RDLS metadata will appear here..."
}
                        </pre>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Enhanced Features:</strong><br>
                                ✅ Real-time validation<br>
                                ✅ Auto-completion with combobox<br>
                                ✅ Open/closed codelists<br>
                                ✅ RDLS v2.1 compliance
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Object Editor Modal -->
    <div class="modal fade" id="objectEditorModal" tabindex="-1" aria-labelledby="objectEditorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg object-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="objectEditorModalLabel">Edit Object</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="objectEditorForm" class="needs-validation" novalidate>
                        <div id="objectEditorFields">
                            <!-- Dynamic form fields will be inserted here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveObjectBtn">Save Object</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // RDLS Schema Configuration
        const RDLS_VERSIONS = {
            '0.2': 'https://docs.riskdatalibrary.org/en/0__2__0/rdls_schema.json',
            '0.2.1': 'https://docs.riskdatalibrary.org/en/0__2__1/rdls_schema.json'
        };

        const SECTIONS = ['hazard', 'exposure', 'vulnerability', 'loss'];
        
        let currentSchema = null;
        let currentFormData = {};
        let activeSections = new Set(['general']);
        let fieldValidationStatus = new Map();

        // Object editor state
        let currentObjectEditor = {
            arrayName: null,
            objectIndex: null,
            objectSchema: null,
            arrayData: null,
            renderCallback: null
        };

        // Auto-completion suggestions for common fields
        const AUTO_COMPLETE_SUGGESTIONS = {
            'title': [
                'Global Flood Risk Assessment',
                'Earthquake Hazard Database',
                'Climate Change Vulnerability Index',
                'Urban Exposure Inventory',
                'Disaster Loss Database'
            ],
            'publisher.name': [
                'World Bank Group',
                'United Nations Office for Disaster Risk Reduction',
                'European Space Agency',
                'National Weather Service'
            ],
            'creator.name': [
                'International Research Institute',
                'National Disaster Management Agency',
                'Climate Change Research Center'
            ],
            'purpose': [
                'Risk assessment for urban planning',
                'Insurance portfolio analysis',
                'Climate adaptation planning',
                'Disaster risk reduction strategy development'
            ]
        };

        // Country names cache
        let countryNames = {};
        
        // Auto-ID generation
        function generateUniqueId(prefix = 'item') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `${prefix}_${result}`;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSchemaVersions();
            loadFromStorage();
            loadCountryNames();
        });

        function setupEventListeners() {
            // Schema version selection
            document.getElementById('schemaVersionSelect').addEventListener('change', loadSelectedSchema);

            // Section checkboxes
            SECTIONS.forEach(section => {
                document.getElementById(`${section}Check`).addEventListener('change', function() {
                    if (this.checked) {
                        activeSections.add(section);
                        addSectionTab(section);
                    } else {
                        activeSections.delete(section);
                        removeSectionTab(section);
                    }
                    updateFormData();
                    generateForm();
                });
            });

            // File upload
            document.getElementById('schemaDropZone').addEventListener('click', () => 
                document.getElementById('schemaFile').click()
            );
            document.getElementById('schemaFile').addEventListener('change', handleSchemaFile);
            
            // Drag and drop
            setupDragAndDrop();

            // Buttons
            document.getElementById('exportJson').addEventListener('click', exportJson);
            document.getElementById('exportXml').addEventListener('click', exportXml);
            document.getElementById('saveProgress').addEventListener('click', saveProgress);
            document.getElementById('loadData').addEventListener('click', loadData);
            document.getElementById('validateForm').addEventListener('click', validateForm);
            
            // Object editor modal
            document.getElementById('saveObjectBtn').addEventListener('click', saveCurrentObject);
        }

        function loadSchemaVersions() {
            const select = document.getElementById('schemaVersionSelect');
            select.innerHTML = '<option value="">Select RDLS version...</option>';
            
            Object.keys(RDLS_VERSIONS).forEach(version => {
                const option = document.createElement('option');
                option.value = version;
                const isLatest = version === '0.2.1';
                option.textContent = `RDLS ${version}${isLatest ? ' (latest - enhanced with combobox)' : ''}`;
                select.appendChild(option);
            });
            
            // Auto-select the latest version
            select.value = '0.2.1';
            loadSelectedSchema();
        }

        async function loadSelectedSchema() {
            const version = document.getElementById('schemaVersionSelect').value;
            if (!version) return;

            updateSchemaStatus('Loading schema...', 'text-info');
            
            try {
                const response = await fetch(RDLS_VERSIONS[version]);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                currentSchema = await response.json();
                updateSchemaStatus(`✓ RDLS ${version} loaded`, 'text-success');
                generateForm();
            } catch (error) {
                updateSchemaStatus(`✗ Failed to load schema: ${error.message}`, 'text-danger');
                console.error('Schema loading error:', error);
            }
        }

        function updateSchemaStatus(message, className) {
            const status = document.getElementById('schemaStatus');
            status.textContent = message;
            status.className = `schema-status ${className}`;
        }

        async function loadCountryNames() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=cca3,name');
                const countries = await response.json();
                countryNames = {};
                countries.forEach(country => {
                    countryNames[country.cca3] = country.name.common;
                });
            } catch (error) {
                console.warn('Could not load country names:', error);
            }
        }

        function handleSchemaFile(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        currentSchema = JSON.parse(e.target.result);
                        const isV21 = currentSchema.title && (currentSchema.title.includes('v2.1') || currentSchema.$id && currentSchema.$id.includes('0__2__1'));
                        const isV20 = currentSchema.title && (currentSchema.title.includes('v2.0') || currentSchema.$id && currentSchema.$id.includes('0__2__0'));
                        let statusMessage = '✓ Custom schema loaded';
                        
                        if (isV21) {
                            statusMessage = '✓ RDLS v2.1 schema loaded (enhanced with combobox fields)';
                        } else if (isV20) {
                            statusMessage = '✓ RDLS v2.0 schema loaded';
                        }
                        
                        updateSchemaStatus(statusMessage, 'text-success');
                        generateForm();
                    } catch (error) {
                        updateSchemaStatus('✗ Invalid JSON file', 'text-danger');
                    }
                };
                reader.readAsText(file);
            }
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('schemaDropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('schemaFile').files = files;
                    handleSchemaFile({target: {files: files}});
                }
            });
        }

        function addSectionTab(section) {
            const tabsContainer = document.getElementById('metadataTabs');
            const contentContainer = document.getElementById('metadataTabContent');
            
            tabsContainer.style.display = 'flex';
            
            const tabButton = document.createElement('li');
            tabButton.className = 'nav-item';
            tabButton.setAttribute('role', 'presentation');
            tabButton.innerHTML = `
                <button class="nav-link ${section}-tab" id="${section}-tab" data-bs-toggle="tab" 
                        data-bs-target="#${section}" type="button" role="tab">
                    ${section.charAt(0).toUpperCase() + section.slice(1)}
                </button>
            `;
            tabsContainer.appendChild(tabButton);
            
            const tabContent = document.createElement('div');
            tabContent.className = 'tab-pane fade';
            tabContent.id = section;
            tabContent.setAttribute('role', 'tabpanel');
            tabContent.innerHTML = `<div id="${section}Form"></div>`;
            contentContainer.appendChild(tabContent);
        }

        function removeSectionTab(section) {
            const tabButton = document.getElementById(`${section}-tab`);
            if (tabButton) tabButton.parentElement.remove();
            
            const tabContent = document.getElementById(section);
            if (tabContent) tabContent.remove();
            
            if (activeSections.size === 1) {
                document.getElementById('metadataTabs').style.display = 'none';
            }
        }

        function generateForm() {
            if (!currentSchema) {
                updateFormStatus('warning', 'No schema loaded');
                return;
            }

            try {
                document.getElementById('metadataForm').innerHTML = '';
                SECTIONS.forEach(section => {
                    const sectionForm = document.getElementById(`${section}Form`);
                    if (sectionForm) sectionForm.innerHTML = '';
                });

                fieldValidationStatus.clear();

                generateSectionForm('general', currentSchema.properties, 'metadataForm');
                
                activeSections.forEach(section => {
                    if (section !== 'general' && currentSchema.properties[section]) {
                        generateSectionForm(section, currentSchema.properties[section].properties, `${section}Form`);
                    }
                });

                updateFormStatus('success', 'RDLS Form Ready');
                updatePreview();
                updateValidationDisplay();

            } catch (error) {
                updateFormStatus('danger', 'Generation Error: ' + error.message);
                console.error('Form generation error:', error);
            }
        }

        function generateSectionForm(sectionName, properties, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !properties) return;

            const form = document.createElement('form');
            form.className = 'needs-validation';
            form.noValidate = true;
            
            form.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const inputs = form.querySelectorAll('input, select, textarea');
                    const currentIndex = Array.from(inputs).indexOf(event.target);
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    }
                }
            });

            const title = document.createElement('h5');
            title.textContent = `${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} Metadata`;
            title.className = 'mb-3 mt-3';
            form.appendChild(title);

            if (sectionName === 'general') {
                Object.entries(properties).forEach(([key, property]) => {
                    if (!SECTIONS.includes(key) && key !== 'links') {
                        const existingValue = currentFormData[key];
                        const fieldElement = createFormField(key, property, existingValue, sectionName);
                        form.appendChild(fieldElement);
                    }
                });
            } else {
                Object.entries(properties).forEach(([key, property]) => {
                    const existingValue = currentFormData[sectionName] && currentFormData[sectionName][key];
                    const fieldElement = createFormField(`${sectionName}.${key}`, property, existingValue, sectionName);
                    form.appendChild(fieldElement);
                });
            }

            container.appendChild(form);
        }

        function createFormField(name, property, value = null, section = 'general') {
            const container = document.createElement('div');
            container.className = 'form-field';
            
            const originalTitle = property.title;
            const originalDescription = property.description;
            
            if (property.$ref) {
                const resolvedProperty = resolveReference(property.$ref);
                if (resolvedProperty) {
                    property = { ...resolvedProperty };
                    if (originalTitle) property.title = originalTitle;
                    if (originalDescription) property.description = originalDescription;
                }
            }
            
            if (!property || !property.type) {
                return container;
            }

            const nameParts = name.split('.');
            const fieldName = nameParts[nameParts.length - 1];
            
            const isArrayIdField = fieldName === 'id' && name !== 'id';
            
            if (isArrayIdField) {
                return container;
            }
            
            const label = document.createElement('label');
            label.textContent = property.title || fieldName;
            label.className = 'form-label';
            label.htmlFor = name;
            
            if (currentSchema.required && currentSchema.required.includes(name)) {
                label.innerHTML += ' <span class="text-danger">*</span>';
                container.classList.add('required');
            }
            
            container.appendChild(label);
            
            if (property.description) {
                const description = document.createElement('small');
                description.className = 'form-text text-muted d-block mb-2';
                description.innerHTML = parseMarkdownLinks(property.description);
                container.appendChild(description);
            }
            
            let input;
            
            // Create appropriate input based on type
            switch (property.type) {
                case 'string':
                    if (property.enum) {
                        // Closed codelist - use dropdown
                        input = createSelectField(name, property, value);
                    } else if (property.suggestions && property.openCodelist) {
                        // Open codelist - use input with suggestions
                        input = createComboboxField(name, property, value);
                    } else if (property.format === 'date') {
                        input = createDateField(name, property, value);
                    } else if (property.format === 'email') {
                        input = createEmailField(name, property, value);
                    } else if (property.format === 'iri') {
                        input = createUrlField(name, property, value);
                    } else {
                        input = createTextField(name, property, value);
                    }
                    break;
                case 'integer':
                case 'number':
                    input = createNumberField(name, property, value);
                    break;
                case 'boolean':
                    input = createCheckboxField(name, property, value);
                    break;
                case 'array':
                    if (name.includes('bbox')) {
                        input = createBboxField(name, property, value);
                    } else {
                        input = createArrayField(name, property, value);
                    }
                    break;
                case 'object':
                    input = createObjectField(name, property, value, property.$ref !== undefined);
                    break;
                default:
                    input = createTextField(name, property, value);
            }
            
            const validationIndicator = document.createElement('span');
            validationIndicator.className = 'validation-indicator';
            validationIndicator.id = `validation-${name}`;
            container.appendChild(validationIndicator);
            
            container.appendChild(input);
            
            if (property.examples && property.examples.length > 0) {
                const hint = document.createElement('div');
                hint.className = 'field-hint';
                hint.innerHTML = `<strong>Examples:</strong> ${property.examples.slice(0, 3).join(', ')}`;
                container.appendChild(hint);
            }
            
            return container;
        }

        function createComboboxField(name, property, value) {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.className = 'combobox-wrapper';
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            input.placeholder = 'Type or select from suggestions...';
            
            if (property.minLength) input.minLength = property.minLength;
            if (property.maxLength) input.maxLength = property.maxLength;
            if (property.pattern) input.pattern = property.pattern;
            
            const dropdownBtn = document.createElement('button');
            dropdownBtn.type = 'button';
            dropdownBtn.className = 'btn btn-outline-secondary dropdown-toggle';
            dropdownBtn.setAttribute('data-bs-toggle', 'dropdown');
            dropdownBtn.innerHTML = '▼';
            
            const dropdownMenu = document.createElement('ul');
            dropdownMenu.className = 'dropdown-menu';
            dropdownMenu.style.maxHeight = '200px';
            dropdownMenu.style.overflowY = 'auto';
            
            if (property.suggestions && property.suggestions.length > 0) {
                property.suggestions.forEach(suggestion => {
                    const item = document.createElement('li');
                    const link = document.createElement('a');
                    link.className = 'dropdown-item';
                    link.href = '#';
                    link.textContent = suggestion;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        input.value = suggestion;
                        updateFormData();
                        validateField(name, suggestion, property);
                    });
                    item.appendChild(link);
                    dropdownMenu.appendChild(item);
                });
                
                const separator = document.createElement('li');
                separator.innerHTML = '<hr class="dropdown-divider">';
                dropdownMenu.appendChild(separator);
                
                const customItem = document.createElement('li');
                customItem.innerHTML = '<span class="dropdown-item-text text-muted"><em>💡 You can also type a custom value</em></span>';
                dropdownMenu.appendChild(customItem);
            }
            
            inputGroup.appendChild(input);
            inputGroup.appendChild(dropdownBtn);
            inputGroup.appendChild(dropdownMenu);
            
            input.addEventListener('input', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            
            wrapper.appendChild(inputGroup);
            
            setupAutoComplete(input, name, property);
            
            return wrapper;
        }

        function setupAutoComplete(input, fieldName, property) {
            let suggestions = [];
            
            if (property.suggestions && property.suggestions.length > 0) {
                suggestions = [...property.suggestions];
            }
            
            if (property.examples && property.examples.length > 0) {
                suggestions = [...suggestions, ...property.examples];
            }
            
            if (AUTO_COMPLETE_SUGGESTIONS[fieldName]) {
                suggestions = [...suggestions, ...AUTO_COMPLETE_SUGGESTIONS[fieldName]];
            }
            
            suggestions = [...new Set(suggestions)];
            
            if (suggestions.length === 0) return;

            const container = input.parentElement;
            
            let suggestionContainer = container;
            if (container.classList.contains('input-group')) {
                suggestionContainer = container.parentElement;
            }
            
            if (!suggestionContainer) {
                console.warn('Cannot setup autocomplete: input has no suitable parent element');
                return;
            }
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'autocomplete-suggestions';
            suggestionContainer.appendChild(suggestionsDiv);

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const matches = suggestions.filter(s => s.toLowerCase().includes(value));
                
                if (matches.length > 0 && value.length > 0) {
                    suggestionsDiv.innerHTML = '';
                    matches.slice(0, 8).forEach(match => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = match;
                        div.addEventListener('click', () => {
                            input.value = match;
                            suggestionsDiv.style.display = 'none';
                            updateFormData();
                            validateField(fieldName, match, property);
                        });
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 150);
            });
        }

        function resolveReference(ref) {
            if (!ref.startsWith('#/$defs/')) return null;
            const defName = ref.replace('#/$defs/', '');
            return currentSchema.$defs && currentSchema.$defs[defName] ? currentSchema.$defs[defName] : null;
        }

        function createTextField(name, property, value) {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            
            if (property.minLength) input.minLength = property.minLength;
            if (property.maxLength) input.maxLength = property.maxLength;
            if (property.pattern) input.pattern = property.pattern;
            
            input.addEventListener('input', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            
            wrapper.appendChild(input);
            setupAutoComplete(input, name, property);
            
            return wrapper;
        }

        function createEmailField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'email';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            
            input.addEventListener('input', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            return input;
        }

        function createUrlField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'url';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            
            input.addEventListener('input', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            return input;
        }

        function createDateField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            
            input.addEventListener('change', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            return input;
        }

        function createNumberField(name, property, value) {
            const input = document.createElement('input');
            input.type = property.type === 'integer' ? 'number' : 'number';
            input.className = 'form-control field-with-validation';
            input.name = name;
            input.id = name;
            input.value = value || '';
            
            if (property.minimum !== undefined) input.min = property.minimum;
            if (property.maximum !== undefined) input.max = property.maximum;
            if (property.type === 'integer') input.step = '1';
            
            input.addEventListener('input', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            return input;
        }

        function createSelectField(name, property, value) {
            const select = document.createElement('select');
            select.className = 'form-select field-with-validation';
            select.name = name;
            select.id = name;
            
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select an option...';
            select.appendChild(emptyOption);
            
            if (name.includes('countries') || (property.items && property.items.enum && property.items.enum.includes('USA'))) {
                property.enum.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    const countryName = countryNames[option] || option;
                    optionElement.textContent = `${option} - ${countryName}`;
                    if (value === option) optionElement.selected = true;
                    select.appendChild(optionElement);
                });
            } else {
                property.enum.forEach((option, index) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = property.enumNames ? property.enumNames[index] : 
                        option.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    if (value === option) optionElement.selected = true;
                    select.appendChild(optionElement);
                });
            }
            
            select.addEventListener('change', function() {
                updateFormData();
                validateField(name, this.value, property);
            });
            return select;
        }

        function createBboxField(name, property, value) {
            const container = document.createElement('div');
            container.className = 'bbox-field border p-3 rounded bg-light';
            
            const title = document.createElement('h6');
            title.textContent = 'Bounding Box Coordinates (SW Longitude, SW Latitude, NE Longitude, NE Latitude)';
            title.className = 'mb-3';
            container.appendChild(title);
            
            const bboxData = value || [0, 0, 0, 0];
            const labels = ['SW Longitude', 'SW Latitude', 'NE Longitude', 'NE Latitude'];
            
            const inputsContainer = document.createElement('div');
            inputsContainer.className = 'row g-2';
            
            function updateBboxPreview() {
                const currentBbox = getNestedValue(currentFormData, name) || [0, 0, 0, 0];
                const previewInput = container.querySelector('.bbox-preview');
                if (previewInput) {
                    previewInput.value = `[${currentBbox.join(', ')}]`;
                }
            }
            
            for (let i = 0; i < 4; i++) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                
                const label = document.createElement('label');
                label.textContent = labels[i];
                label.className = 'form-label';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.step = 'any';
                input.className = 'form-control';
                input.name = `${name}_${i}`;
                input.value = bboxData[i] || 0;
                input.placeholder = i % 2 === 0 ? 'Longitude' : 'Latitude';
                
                input.addEventListener('input', function() {
                    const currentBbox = getNestedValue(currentFormData, name) || [0, 0, 0, 0];
                    currentBbox[i] = parseFloat(this.value) || 0;
                    setNestedValue(currentFormData, name, currentBbox);
                    updateFormData();
                    validateField(name, currentBbox, property);
                    updateBboxPreview();
                });
                
                col.appendChild(label);
                col.appendChild(input);
                inputsContainer.appendChild(col);
            }
            
            container.appendChild(inputsContainer);
            
            const previewContainer = document.createElement('div');
            previewContainer.className = 'mt-3';
            
            const previewLabel = document.createElement('label');
            previewLabel.textContent = 'Bounding Box Array Format:';
            previewLabel.className = 'form-label';
            
            const previewInput = document.createElement('input');
            previewInput.type = 'text';
            previewInput.className = 'form-control bbox-preview';
            previewInput.readOnly = true;
            previewInput.value = `[${bboxData.join(', ')}]`;
            previewInput.style.backgroundColor = '#f8f9fa';
            previewInput.style.fontFamily = 'monospace';
            
            previewContainer.appendChild(previewLabel);
            previewContainer.appendChild(previewInput);
            container.appendChild(previewContainer);
            
            const helpText = document.createElement('small');
            helpText.className = 'form-text text-muted mt-2 d-block';
            helpText.innerHTML = 'Enter coordinates in decimal degrees using WGS84 datum. Example: London area would be approximately: -0.5, 51.2, 0.2, 51.7';
            container.appendChild(helpText);
            
            return container;
        }

        function createCheckboxField(name, property, value) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check';
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.name = name;
            input.id = name;
            input.checked = value || false;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = name;
            label.textContent = property.title || name;
            
            wrapper.appendChild(input);
            wrapper.appendChild(label);
            
            input.addEventListener('change', function() {
                updateFormData();
                validateField(name, this.checked, property);
            });
            return wrapper;
        }

        function createArrayField(name, property, value) {
            const container = document.createElement('div');
            container.className = 'array-field';
            
            const arrayData = value || [];
            
            const itemsContainer = document.createElement('div');
            itemsContainer.id = `${name}_items`;
            
            function renderArrayItems() {
                itemsContainer.innerHTML = '';
                
                if (property.items.$ref || property.items.type === 'object') {
                    arrayData.forEach((item, index) => {
                        const objectCard = createObjectSummaryCard(item, index, name, property);
                        itemsContainer.appendChild(objectCard);
                    });
                } else {
                    arrayData.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'array-item d-flex gap-2 align-items-center mb-2';
                        
                        let input;
                        if (property.items.type === 'string') {
                            if (property.items.enum) {
                                input = document.createElement('select');
                                input.className = 'form-select';
                                
                                const emptyOption = document.createElement('option');
                                emptyOption.value = '';
                                emptyOption.textContent = 'Select...';
                                input.appendChild(emptyOption);
                                
                                if (property.items.enum.includes('USA') || property.items.enum.includes('GBR')) {
                                    property.items.enum.forEach((option) => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        const countryName = countryNames[option] || option;
                                        optionElement.textContent = `${option} - ${countryName}`;
                                        if (item === option) optionElement.selected = true;
                                        input.appendChild(optionElement);
                                    });
                                } else {
                                    property.items.enum.forEach((option, idx) => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        optionElement.textContent = property.items.enumNames ? 
                                            property.items.enumNames[idx] : option;
                                        if (item === option) optionElement.selected = true;
                                        input.appendChild(optionElement);
                                    });
                                }
                            } else {
                                input = document.createElement('input');
                                input.type = 'text';
                                input.className = 'form-control';
                                input.value = item;
                            }
                            
                            input.addEventListener('change', (e) => {
                                arrayData[index] = e.target.value;
                                updateFormData();
                                validateField(name, arrayData, property);
                            });
                        }
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'btn btn-outline-danger btn-sm';
                        removeBtn.textContent = '×';
                        removeBtn.addEventListener('click', () => {
                            arrayData.splice(index, 1);
                            renderArrayItems();
                            updateFormData();
                            validateField(name, arrayData, property);
                        });
                        
                        itemDiv.appendChild(input);
                        itemDiv.appendChild(removeBtn);
                        itemsContainer.appendChild(itemDiv);
                    });
                }
            }
            
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-outline-primary btn-sm mb-2';
            addBtn.textContent = `+ Add ${property.title || name}`;
            addBtn.addEventListener('click', () => {
                if (property.items.$ref || property.items.type === 'object') {
                    openObjectEditor(name, arrayData.length, property.items, arrayData, renderArrayItems);
                } else if (property.items.type === 'string') {
                    arrayData.push('');
                    renderArrayItems();
                    updateFormData();
                    validateField(name, arrayData, property);
                } else {
                    arrayData.push({});
                    renderArrayItems();
                    updateFormData();
                    validateField(name, arrayData, property);
                }
            });
            
            container.appendChild(addBtn);
            container.appendChild(itemsContainer);
            
            renderArrayItems();
            return container;
        }

        function createObjectField(name, property, value, wasRefField = false) {
            const container = document.createElement('div');
            container.className = 'object-field';
            
            const isDirectFormProperty = !name.includes('.') || name.split('.').length <= 2;
            
            if (!isDirectFormProperty) {
                const title = document.createElement('h6');
                title.textContent = property.title || name;
                title.className = 'mb-3';
                container.appendChild(title);
            }
            
            if (property.properties) {
                Object.entries(property.properties).forEach(([key, prop]) => {
                    const fieldValue = value && value[key] ? value[key] : null;
                    const field = createFormField(`${name}.${key}`, prop, fieldValue);
                    container.appendChild(field);
                });
            }
            
            return container;
        }

        function createObjectSummaryCard(objectData, index, arrayName, arrayProperty) {
            const card = document.createElement('div');
            card.className = 'object-summary-card';
            
            let objectSchema = arrayProperty.items;
            if (objectSchema.$ref) {
                objectSchema = resolveReference(objectSchema.$ref);
            }
            
            const title = document.createElement('div');
            title.className = 'object-summary-title';
            
            let summaryText = `${arrayProperty.title || arrayName} ${index + 1}`;
            if (objectData) {
                if ((arrayName.includes('metric') || arrayName.includes('cost')) && objectData.dimension) {
                    summaryText = `${objectData.dimension.charAt(0).toUpperCase() + objectData.dimension.slice(1)} ${arrayProperty.title || arrayName}`;
                } else if (objectData.name) {
                    summaryText = objectData.name;
                } else if (objectData.title) {
                    summaryText = objectData.title;
                } else if (objectData.id) {
                    summaryText = objectData.id;
                }
            }
            title.textContent = summaryText;
            
            const details = document.createElement('div');
            details.className = 'object-summary-details';
            
            if (objectData) {
                let keyFields = [];
                
                if (arrayName.includes('metric') && objectData.quantity_kind) {
                    keyFields.push(`quantity: ${objectData.quantity_kind}`);
                }
                
                if (arrayName.includes('cost') && objectData.unit) {
                    keyFields.push(`unit: ${objectData.unit}`);
                }
                
                const otherFields = ['description', 'format', 'role', 'type', 'url'].filter(field => 
                    objectData[field] && !keyFields.some(kf => kf.includes(field))
                );
                keyFields = keyFields.concat(otherFields.map(field => `${field}: ${objectData[field]}`));
                
                if (keyFields.length > 0) {
                    details.textContent = keyFields.join(' • ');
                } else {
                    details.textContent = 'Click Edit to add details';
                }
            } else {
                details.textContent = 'New object - click Edit to configure';
            }
            
            const actions = document.createElement('div');
            actions.className = 'd-flex gap-2 mt-2';
            
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-outline-primary btn-sm';
            editBtn.textContent = '✏️ Edit';
            editBtn.addEventListener('click', () => {
                openObjectEditor(arrayName, index, arrayProperty.items, null, null);
            });
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-outline-danger btn-sm';
            removeBtn.textContent = '🗑️ Remove';
            removeBtn.addEventListener('click', () => {
                if (confirm(`Remove this ${arrayProperty.title || arrayName}?`)) {
                    const fullArrayData = getNestedValue(currentFormData, arrayName) || [];
                    fullArrayData.splice(index, 1);
                    setNestedValue(currentFormData, arrayName, fullArrayData);
                    updateFormData();
                    generateForm();
                }
            });
            
            actions.appendChild(editBtn);
            actions.appendChild(removeBtn);
            
            card.appendChild(title);
            card.appendChild(details);
            card.appendChild(actions);
            
            return card;
        }

        function openObjectEditor(arrayName, objectIndex, objectSchema, arrayData, renderCallback) {
            if (objectSchema.$ref) {
                objectSchema = resolveReference(objectSchema.$ref);
            }
            
            currentObjectEditor = {
                arrayName: arrayName,
                objectIndex: objectIndex,
                objectSchema: objectSchema,
                arrayData: arrayData,
                renderCallback: renderCallback
            };
            
            const modalTitle = document.getElementById('objectEditorModalLabel');
            modalTitle.textContent = `Edit ${objectSchema.title || arrayName}`;
            
            const fullArrayData = getNestedValue(currentFormData, arrayName) || [];
            const objectData = fullArrayData[objectIndex] || {};
            
            const fieldsContainer = document.getElementById('objectEditorFields');
            fieldsContainer.innerHTML = '';
            
            if (objectSchema.properties) {
                Object.entries(objectSchema.properties).forEach(([key, property]) => {
                    const fieldElement = createModalFormField(key, property, objectData[key]);
                    fieldsContainer.appendChild(fieldElement);
                });
            }
            
            const form = document.getElementById('objectEditorForm');
            form.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const inputs = form.querySelectorAll('input, select, textarea');
                    const currentIndex = Array.from(inputs).indexOf(event.target);
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    } else {
                        document.getElementById('saveObjectBtn').click();
                    }
                }
            });
            
            const modal = new bootstrap.Modal(document.getElementById('objectEditorModal'));
            modal.show();
        }

        function createModalFormField(name, property, value = null) {
            const container = document.createElement('div');
            container.className = 'modal-form-field';
            
            if (name === 'id') {
                return container;
            }
            
            const label = document.createElement('label');
            label.textContent = property.title || name;
            label.className = 'form-label';
            label.htmlFor = `modal_${name}`;
            
            if (currentObjectEditor.objectSchema.required && 
                currentObjectEditor.objectSchema.required.includes(name)) {
                label.innerHTML += ' <span class="text-danger">*</span>';
                container.classList.add('required');
            }
            
            container.appendChild(label);
            
            if (property.description) {
                const description = document.createElement('small');
                description.className = 'form-text text-muted d-block mb-2';
                description.innerHTML = parseMarkdownLinks(property.description);
                container.appendChild(description);
            }
            
            let input;
            
            // Create appropriate input based on type
            switch (property.type) {
                case 'string':
                    if (property.enum) {
                        // Closed codelist - use dropdown
                        input = createModalSelectField(name, property, value);
                    } else if (property.suggestions && property.openCodelist) {
                        // Open codelist - use input with suggestions
                        input = createModalComboboxField(name, property, value);
                    } else if (property.format === 'date') {
                        input = createModalDateField(name, property, value);
                    } else if (property.format === 'email') {
                        input = createModalEmailField(name, property, value);
                    } else if (property.format === 'iri') {
                        input = createModalUrlField(name, property, value);
                    } else {
                        input = createModalTextField(name, property, value);
                    }
                    break;
                case 'integer':
                case 'number':
                    input = createModalNumberField(name, property, value);
                    break;
                case 'boolean':
                    input = createModalCheckboxField(name, property, value);
                    break;
                default:
                    input = createModalTextField(name, property, value);
            }
            
            container.appendChild(input);
            
            if (property.examples && property.examples.length > 0) {
                const hint = document.createElement('div');
                hint.className = 'field-hint';
                hint.innerHTML = `<strong>Examples:</strong> ${property.examples.slice(0, 3).join(', ')}`;
                container.appendChild(hint);
            }
            
            return container;
        }

        function createModalComboboxField(name, property, value) {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            input.placeholder = 'Type or select from suggestions...';
            
            if (property.minLength) input.minLength = property.minLength;
            if (property.maxLength) input.maxLength = property.maxLength;
            if (property.pattern) input.pattern = property.pattern;
            
            wrapper.appendChild(input);
            
            if (property.suggestions && property.suggestions.length > 0) {
                const datalist = document.createElement('datalist');
                datalist.id = `modal_${name}_suggestions`;
                input.setAttribute('list', datalist.id);
                
                property.suggestions.forEach(suggestion => {
                    const option = document.createElement('option');
                    option.value = suggestion;
                    datalist.appendChild(option);
                });
                
                wrapper.appendChild(datalist);
            }
            
            return wrapper;
        }

        function createModalTextField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            
            if (property.minLength) input.minLength = property.minLength;
            if (property.maxLength) input.maxLength = property.maxLength;
            if (property.pattern) input.pattern = property.pattern;
            
            return input;
        }

        function createModalEmailField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'email';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            return input;
        }

        function createModalUrlField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'url';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            return input;
        }

        function createModalDateField(name, property, value) {
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            return input;
        }

        function createModalNumberField(name, property, value) {
            const input = document.createElement('input');
            input.type = property.type === 'integer' ? 'number' : 'number';
            input.className = 'form-control';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.value = value || '';
            
            if (property.minimum !== undefined) input.min = property.minimum;
            if (property.maximum !== undefined) input.max = property.maximum;
            if (property.type === 'integer') input.step = '1';
            
            return input;
        }

        function createModalSelectField(name, property, value) {
            const select = document.createElement('select');
            select.className = 'form-select';
            select.name = `modal_${name}`;
            select.id = `modal_${name}`;
            
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select an option...';
            select.appendChild(emptyOption);
            
            if (property.enum && (property.enum.includes('USA') || property.enum.includes('GBR'))) {
                property.enum.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    const countryName = countryNames[option] || option;
                    optionElement.textContent = `${option} - ${countryName}`;
                    if (value === option) optionElement.selected = true;
                    select.appendChild(optionElement);
                });
            } else {
                property.enum.forEach((option, index) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = property.enumNames ? property.enumNames[index] : 
                        option.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    if (value === option) optionElement.selected = true;
                    select.appendChild(optionElement);
                });
            }
            
            return select;
        }

        function createModalCheckboxField(name, property, value) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check';
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.name = `modal_${name}`;
            input.id = `modal_${name}`;
            input.checked = value || false;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `modal_${name}`;
            label.textContent = property.title || name;
            
            wrapper.appendChild(input);
            wrapper.appendChild(label);
            
            return wrapper;
        }

        function parseMarkdownLinks(text) {
            if (!text) return text;
            
            const markdownLinkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
            
            return text.replace(markdownLinkRegex, function(match, linkText, url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary text-decoration-none">${linkText} <small>↗</small></a>`;
            });
        }

        function getNestedValue(obj, path) {
            const keys = path.split('.');
            let current = obj;
            
            for (const key of keys) {
                if (current && current[key] !== undefined) {
                    current = current[key];
                } else {
                    return null;
                }
            }
            
            return current;
        }

        function saveCurrentObject() {
            const form = document.getElementById('objectEditorForm');
            const formData = new FormData(form);
            
            const objectData = {};
            for (let [key, value] of formData.entries()) {
                const fieldName = key.replace('modal_', '');
                
                if (fieldName.includes('.')) {
                    setNestedValue(objectData, fieldName, value);
                } else {
                    objectData[fieldName] = value;
                }
            }
            
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const fieldName = cb.name.replace('modal_', '');
                if (fieldName.includes('.')) {
                    setNestedValue(objectData, fieldName, cb.checked);
                } else {
                    objectData[fieldName] = cb.checked;
                }
            });
            
            let fullArrayData = getNestedValue(currentFormData, currentObjectEditor.arrayName);
            if (!fullArrayData) {
                fullArrayData = [];
                setNestedValue(currentFormData, currentObjectEditor.arrayName, fullArrayData);
            }
            
            if (currentObjectEditor.objectIndex >= fullArrayData.length) {
                let idPrefix = 'item';
                if (currentObjectEditor.arrayName === 'resources') idPrefix = 'resource';
                else if (currentObjectEditor.arrayName === 'sources') idPrefix = 'source';
                else if (currentObjectEditor.arrayName === 'attributions') idPrefix = 'attribution';
                else if (currentObjectEditor.arrayName === 'referenced_by') idPrefix = 'reference';
                
                objectData.id = generateUniqueId(idPrefix);
            } else {
                const existingObject = fullArrayData[currentObjectEditor.objectIndex];
                if (existingObject && existingObject.id) {
                    objectData.id = existingObject.id;
                } else {
                    let idPrefix = 'item';
                    if (currentObjectEditor.arrayName === 'resources') idPrefix = 'resource';
                    else if (currentObjectEditor.arrayName === 'sources') idPrefix = 'source';
                    else if (currentObjectEditor.arrayName === 'attributions') idPrefix = 'attribution';
                    else if (currentObjectEditor.arrayName === 'referenced_by') idPrefix = 'reference';
                    
                    objectData.id = generateUniqueId(idPrefix);
                }
            }
            
            if (currentObjectEditor.objectIndex >= fullArrayData.length) {
                fullArrayData.push(objectData);
            } else {
                fullArrayData[currentObjectEditor.objectIndex] = objectData;
            }
            
            setNestedValue(currentFormData, currentObjectEditor.arrayName, fullArrayData);
            updatePreview();
            generateForm();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('objectEditorModal'));
            modal.hide();
            
            updateFormStatus('success', 'Object saved successfully');
        }

        function validateField(fieldName, value, property) {
            let isValid = true;
            let errorMessage = '';

            if (currentSchema.required && currentSchema.required.includes(fieldName) && 
                (!value || (typeof value === 'string' && value.trim() === ''))) {
                isValid = false;
                errorMessage = 'Required field';
            }
            
            if (value && typeof value === 'string') {
                if (property.minLength && value.length < property.minLength) {
                    isValid = false;
                    errorMessage = `Minimum ${property.minLength} characters`;
                }
                if (property.format === 'email' && value && !isValidEmail(value)) {
                    isValid = false;
                    errorMessage = 'Invalid email format';
                }
                if (property.format === 'iri' && value && !isValidUrl(value)) {
                    isValid = false;
                    errorMessage = 'Invalid URL format';
                }
            }

            fieldValidationStatus.set(fieldName, { isValid, errorMessage });
            
            const indicator = document.getElementById(`validation-${fieldName}`);
            if (indicator) {
                if (isValid) {
                    indicator.className = 'validation-indicator valid';
                    indicator.textContent = '✓';
                    indicator.title = 'Valid';
                } else {
                    indicator.className = 'validation-indicator invalid';
                    indicator.textContent = '✗';
                    indicator.title = errorMessage;
                }
            }
            
            updateValidationDisplay();
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        function updateValidationDisplay() {
            const totalFields = fieldValidationStatus.size;
            const validFields = Array.from(fieldValidationStatus.values()).filter(status => status.isValid).length;
            
            const progressBar = document.getElementById('validationProgress');
            const progressPercent = totalFields > 0 ? (validFields / totalFields) * 100 : 0;
            progressBar.style.width = `${progressPercent}%`;
            
            document.getElementById('validFieldCount').textContent = validFields;
            document.getElementById('totalFieldCount').textContent = totalFields;
            
            const overallStatus = document.getElementById('overallValidation');
            if (totalFields === 0) {
                overallStatus.className = 'badge bg-secondary';
                overallStatus.textContent = 'Not validated';
            } else if (validFields === totalFields) {
                overallStatus.className = 'badge bg-success';
                overallStatus.textContent = 'All valid';
            } else {
                overallStatus.className = 'badge bg-warning';
                overallStatus.textContent = `${validFields}/${totalFields} valid`;
            }
        }

        function updateFormData() {
            const allForms = document.querySelectorAll('#metadataTabContent form');
            const newFormData = {};
            
            allForms.forEach(form => {
                const formData = new FormData(form);
                
                for (let [key, value] of formData.entries()) {
                    if (!key.includes('_0') && !key.includes('_1') && !key.includes('_2') && !key.includes('_3')) {
                        setNestedValue(newFormData, key, value);
                    }
                }
                
                const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    setNestedValue(newFormData, cb.name, cb.checked);
                });
                
                const bboxFields = form.querySelectorAll('input[name*="_0"], input[name*="_1"], input[name*="_2"], input[name*="_3"]');
                const bboxGroups = {};
                bboxFields.forEach(input => {
                    const match = input.name.match(/(.+)_(\d+)$/);
                    if (match) {
                        const fieldName = match[1];
                        const index = parseInt(match[2]);
                        if (!bboxGroups[fieldName]) bboxGroups[fieldName] = [];
                        bboxGroups[fieldName][index] = parseFloat(input.value) || 0;
                    }
                });
                
                Object.entries(bboxGroups).forEach(([fieldName, values]) => {
                    setNestedValue(newFormData, fieldName, values);
                });
            });
            
            if (currentFormData.resources) {
                newFormData.resources = currentFormData.resources;
            }
            if (currentFormData.sources) {
                newFormData.sources = currentFormData.sources;
            }
            if (currentFormData.attributions) {
                newFormData.attributions = currentFormData.attributions;
            }
            if (currentFormData.referenced_by) {
                newFormData.referenced_by = currentFormData.referenced_by;
            }
            
            currentFormData = { ...currentFormData, ...newFormData };
            
            updatePreview();
            autoSave();
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let current = obj;
            
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            
            current[keys[keys.length - 1]] = value;
        }

        function updatePreview() {
            document.getElementById('outputPreview').textContent = JSON.stringify(currentFormData, null, 2);
        }

        function updateFormStatus(type, message) {
            const status = document.getElementById('formStatus');
            status.className = `badge bg-${type}`;
            status.textContent = message;
        }

        function validateForm() {
            updateFormData();
            
            const allInputs = document.querySelectorAll('#metadataTabContent input, #metadataTabContent select, #metadataTabContent textarea');
            allInputs.forEach(input => {
                if (input.name) {
                    const property = getPropertyFromSchema(input.name);
                    if (property) {
                        const value = input.type === 'checkbox' ? input.checked : input.value;
                        validateField(input.name, value, property);
                    }
                }
            });
            
            const totalFields = fieldValidationStatus.size;
            const validFields = Array.from(fieldValidationStatus.values()).filter(status => status.isValid).length;
            
            if (validFields === totalFields && totalFields > 0) {
                updateFormStatus('success', 'RDLS Compliant ✓');
                alert('✅ All fields are valid! Your metadata is RDLS compliant.');
            } else {
                const invalidFields = Array.from(fieldValidationStatus.entries())
                    .filter(([name, status]) => !status.isValid)
                    .map(([name, status]) => `${name}: ${status.errorMessage}`);
                updateFormStatus('warning', `${validFields}/${totalFields} valid`);
                alert(`⚠️ ${invalidFields.length} field(s) need attention:\n\n• ${invalidFields.join('\n• ')}`);
            }
        }

        function getPropertyFromSchema(fieldName) {
            if (!currentSchema) return null;
            
            const parts = fieldName.split('.');
            let current = currentSchema.properties;
            
            for (const part of parts) {
                if (current[part]) {
                    current = current[part];
                } else {
                    return null;
                }
            }
            
            return current;
        }

        function exportJson() {
            if (Object.keys(currentFormData).length === 0) {
                alert('No data to export. Please fill out the form first.');
                return;
            }
            
            const blob = new Blob([JSON.stringify(currentFormData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rdls_metadata.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportXml() {
            if (Object.keys(currentFormData).length === 0) {
                alert('No data to export. Please fill out the form first.');
                return;
            }
            
            const xml = jsonToXml(currentFormData, 'rdls_dataset');
            const blob = new Blob([xml], {type: 'application/xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rdls_metadata.xml';
            a.click();
            URL.revokeObjectURL(url);
        }

        function jsonToXml(obj, rootName = 'root') {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<${rootName}>\n`;
            
            function objectToXml(obj, indent = '  ') {
                let result = '';
                for (const [key, value] of Object.entries(obj)) {
                    if (Array.isArray(value)) {
                        value.forEach(item => {
                            result += `${indent}<${key}>${escapeXml(item)}</${key}>\n`;
                        });
                    } else if (typeof value === 'object' && value !== null) {
                        result += `${indent}<${key}>\n${objectToXml(value, indent + '  ')}${indent}</${key}>\n`;
                    } else {
                        result += `${indent}<${key}>${escapeXml(value)}</${key}>\n`;
                    }
                }
                return result;
            }
            
            xml += objectToXml(obj);
            xml += `</${rootName}>`;
            return xml;
        }

        function escapeXml(text) {
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function autoSave() {
            localStorage.setItem('rdlsEditor_formData', JSON.stringify(currentFormData));
            localStorage.setItem('rdlsEditor_activeSections', JSON.stringify([...activeSections]));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('rdlsEditor_formData');
            const savedSections = localStorage.getItem('rdlsEditor_activeSections');
            
            if (savedData) {
                try {
                    currentFormData = JSON.parse(savedData);
                    updatePreview();
                } catch (e) {
                    console.warn('Could not load saved form data');
                }
            }
            
            if (savedSections) {
                try {
                    const sections = JSON.parse(savedSections);
                    sections.forEach(section => {
                        if (section !== 'general') {
                            activeSections.add(section);
                            document.getElementById(`${section}Check`).checked = true;
                            addSectionTab(section);
                        }
                    });
                } catch (e) {
                    console.warn('Could not load saved sections');
                }
            }
        }

        function saveProgress() {
            autoSave();
            alert('Progress saved to browser storage!');
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            currentFormData = JSON.parse(event.target.result);
                            updatePreview();
                            generateForm();
                        } catch (error) {
                            alert('Invalid JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
    </script>
</body>
</html>