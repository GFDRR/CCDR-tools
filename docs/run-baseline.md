# Baseline risk

Once required input layers have been created according to [tool setup](tool-setup), the analysis can run.

- Select [CCDR.ipynb](https://github.com/GFDRR/CCDR-tools/blob/main/tools/notebooks/CCDR.ipynb) and chose the hazard to analyse.

```{figure} images/ccdr-nb.png
---
align: center
---
Starting page for the CCDR python notebooks
```

- Execute all cells in the notebook (top bar > `Cell` > `Run all`). The last one will present the user interface. Select the country of interest, the exposure category and the level of administrative boundaries aggregation.


```{figure} images/ccdr-nb_settings.png
---
align: center
---
Settings from one of the python notebooks
```

```{note}
Not all combinations of hazards x exposure are supported; some are not covered by appropriate damage functions or classification (read [more](intro-risk)).
Select the analytical approach accordingly.
```

## Analytical approach: Expected Annual Impact
This approach uses a mathematical relationship to calculate impact over exposed categories (read [more](EAI)).
For example, flood hazard impact over population is calculated using a mortality function, while the impact over built-up uses a damage function for buildings.

The functions can be manually edited in the notebook, if a better model is available for the country of interest.

```
def damage_factor_builtup(x):
    """A polynomial fit to average damage across builtup land cover relative 
    to water depth in meters in Asia.

    The sectors are commercial, industry, transport, infrastructure and residential.

    Values are capped between 0 and 1, where water depth values >= 6m return a damage factor of 1

    References
    ----------
    .. [1] JRC, 2017
    """
    return np.maximum(0.0, np.minimum(1.0, -0.0028*x**3 + 0.0362*x**2 + 0.0095*x)) 	# Floods - AFRICA
    #return np.maximum(0.0, np.minimum(1.0, 0.9981236 - 0.9946279*np.exp(-1.711056*x))) # Floods - LAC
    #return np.maximum(0.0, np.minimum(1.0, 0.00723*x**3 - 0.1000*x**2 + 0.5060*x))	# Floods - ASIA
```

A minimum threshold can be set to ignore all values below - assuming that all risk is avoided under this threshold.

<img width=400 src="https://user-images.githubusercontent.com/44863827/156601233-8bb33d74-127a-4e60-93a3-0cc683d0efba.png">

A chart of the impact function can be generated in the interface for the selected exposure category.

<img width=400 src="https://user-images.githubusercontent.com/44863827/156601989-4997c63c-8c2a-4ce4-b6f9-bb7bb0506799.png">

If you want to inspect all steps of the processing, you can select the option to export all by-products as tiff files:

- [X] Export Intermediate rasters

```{figure} images/run_analysis.png
---
width: 180 px
align: center
---
Click the button to start the processing
```

Once the analysis finishes, results are exported as geospatial data (.gpkg) and table (.csv).

By selecting:

- [X] Preview results

A map will be generated at the end of the run, using a simple simbology.

```{figure} https://user-images.githubusercontent.com/44863827/156605538-85af4764-a2cb-4d0f-8046-a59fdcbed50b.png
---
align: center
---
Example of output preview generated by the script: flood risk over built-up in Nepal
```

The map can be zoomed and inspected with the pointer to show all the values in the table.

```{figure} https://user-images.githubusercontent.com/44863827/156605784-b80e4ba8-aafd-4316-b9f8-d3657230a1d4.png
---
align: center
width: 500 px
---
Example of output preview, subnational unit attributes as generated by the script: individual scenario exposure, impact and EAI summary
```

As explained in the [risk concepts](intro-risk), EAI represents the aggregated absolute risk estimate:
 - **Fatalities [#] or mortality risk** when considering impact over population;
 - **Hectars [ha] of built-up destroyed** when considering impact over built-up.

